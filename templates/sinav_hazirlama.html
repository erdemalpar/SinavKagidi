{% extends "base.html" %}

{% block title %}SÄ±nav HazÄ±rla - SÄ±nav KaÄŸÄ±dÄ± HazÄ±rlama{% endblock %}

{% block extra_styles %}
<style>
    .soru-secili {
        border-color: #667eea;
        background: linear-gradient(135deg, #f3f4f6 0%, #e0e7ff 100%);
    }

    .drag-over {
        border-color: #10b981;
        background-color: #d1fae5;
    }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-12 gap-3 -mt-8">

    <!-- ÃœST PANEL: SeÃ§ilen Sorular Dashboard (Yatay) - %30 KÃ¼Ã§Ã¼ltÃ¼ldÃ¼ -->
    <div class="mb-3 no-print col-span-full" style="zoom: 0.7;">
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200">
            <div class="gradient-warning p-4 text-white flex flex-wrap items-center justify-between gap-4">
                <h2 class="text-xl font-bold flex items-center gap-2 shrink-0">
                    <i data-lucide="list-checks" class="w-6 h-6"></i>
                    SeÃ§ilen Sorular
                </h2>
                <div class="flex items-center gap-4 overflow-x-auto pb-2 sm:pb-0 grow justify-center">
                    <!-- Dashboard KartlarÄ± -->
                    <div
                        class="bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-xl flex items-center gap-3 border border-white/10 shrink-0">
                        <div class="text-[10px] uppercase tracking-wider opacity-90 font-bold">Soru</div>
                        <div class="text-2xl font-black" id="toplamSoruSayisi">0</div>
                    </div>
                    <div
                        class="bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-xl flex items-center gap-3 border border-white/10 shrink-0">
                        <div class="text-[10px] uppercase tracking-wider opacity-90 font-bold">Puan</div>
                        <div class="text-2xl font-black" id="toplamPuan">0</div>
                    </div>
                    <div
                        class="bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-xl flex items-center gap-3 border border-white/10 shrink-0">
                        <div class="text-[10px] uppercase tracking-wider opacity-90 font-bold">Ortalama</div>
                        <div class="text-2xl font-black" id="ortalamaPuan">0</div>
                    </div>
                    <button onclick="tumSorulariTemizle()"
                        class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-xl font-bold transition-all flex items-center gap-2 border border-white/20 shrink-0">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        Temizle
                    </button>
                </div>
            </div>

            <!-- Yatay Soru Listesi (Ã–nizleme) -->
            <div id="secilenSorularListe"
                class="p-3 flex gap-2 overflow-x-auto bg-slate-50 border-t border-slate-100 min-h-[90px] items-center">
                <div class="text-center w-full py-2 text-slate-400 flex items-center justify-center gap-2">
                    <i data-lucide="mouse-pointer-click" class="w-5 h-5"></i>
                    <p class="text-sm font-medium">Soru bankasÄ±ndan soru seÃ§erek baÅŸlayÄ±n</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SAÄž PANEL MODÃœLÃœ BÄ°TÄ°ÅžÄ° (Soru BankasÄ± BaÅŸlangÄ±cÄ±) -->
    <div class="lg:col-span-8 space-y-3">
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="gradient-primary p-4 text-white flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold flex items-center gap-3">
                        <i data-lucide="database" class="w-7 h-7"></i>
                        Soru BankasÄ±
                    </h1>
                    <p class="text-sm opacity-90 mt-1">SÄ±navÄ±nÄ±za eklemek istediÄŸiniz sorularÄ± buradan seÃ§ebilirsiniz
                    </p>
                </div>
            </div>

            <!-- Filtreler -->
            <div class="p-3 bg-slate-50 border-b border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <input type="text" id="soruAra" placeholder="Soru ara..."
                        class="px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-all">
                    <select id="konuFiltre"
                        class="px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-all">
                        <option value="">TÃ¼m Konular</option>
                    </select>
                    <select id="zorlukFiltre"
                        class="px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:outline-none transition-all">
                        <option value="">TÃ¼m Zorluklar</option>
                        <option value="Kolay">ðŸŸ¢ Kolay</option>
                        <option value="Orta">ðŸŸ¡ Orta</option>
                        <option value="Zor">ðŸ”´ Zor</option>
                    </select>
                </div>
            </div>

            <!-- Toplu Ä°ÅŸlemler -->
            <div
                class="px-4 py-3 flex flex-wrap items-center justify-between border-b border-slate-100 bg-white sticky top-0 z-10 gap-4">
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer group select-none">
                        <input type="checkbox" id="tumunuSecCheckbox" class="hidden" onchange="tumunuSecToggle(this)">
                        <div
                            class="w-5 h-5 border-2 border-slate-300 rounded flex items-center justify-center group-hover:border-indigo-500 transition-colors bg-white">
                            <i data-lucide="check"
                                class="w-3.5 h-3.5 text-indigo-600 opacity-0 group-[.checked]:opacity-100"></i>
                        </div>
                        <span
                            class="text-[11px] font-bold text-slate-500 group-hover:text-indigo-600 transition-colors uppercase tracking-wider">TÃ¼mÃ¼nÃ¼
                            SeÃ§</span>
                    </label>
                </div>

                <!-- Rastgele Soru SeÃ§me Paneli (Yeni Ã–zellik) -->
                <div class="flex items-center gap-2 bg-slate-50 p-1.5 rounded-xl border border-slate-200">
                    <i data-lucide="shuffle" class="w-4 h-4 text-indigo-500 ml-2"></i>
                    <select id="rastgeleKonu"
                        class="bg-transparent text-xs font-bold text-slate-700 outline-none border-none focus:ring-0 cursor-pointer min-w-[120px]">
                        <option value="">TÃ¼m Konulardan</option>
                    </select>
                    <div class="h-4 w-px bg-slate-200 mx-1"></div>
                    <input type="number" id="rastgeleAdet" value="5" min="1" max="20"
                        class="bg-transparent w-10 text-center text-xs font-bold text-indigo-600 outline-none">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Soru</span>
                    <button onclick="rastgeleSoruSec()"
                        class="ml-2 bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all active:scale-95 flex items-center gap-1.5 shadow-sm">
                        SeÃ§ ve Ekle
                    </button>
                </div>
            </div>

            <!-- Sorular Listesi (Izgara YapÄ±sÄ±) -->
            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[800px] overflow-y-auto bg-slate-50/50">
                {% if sorular %}
                {% for soru in sorular %}
                <div class="soru-kart border-2 border-slate-200 rounded-xl p-3 cursor-pointer hover:shadow-lg transition-all"
                    data-soru-id="{{ soru.id }}" data-soru-konu="{{ soru.konu or '' }}"
                    data-soru-zorluk="{{ soru.zorluk }}" onclick="soruSec({{ soru.id }}, this)">
                    <div class="flex items-start justify-between mb-1.5">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center">
                                <input type="checkbox" class="soru-checkbox w-4 h-4" data-soru-id="{{ soru.id }}">
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                                #{{ soru.id }}
                            </span>
                            {% if soru.konu %}
                            <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                {{ soru.konu }}
                            </span>
                            {% endif %}
                            <span class="px-2 py-1 rounded-full text-xs font-medium 
                                    {% if soru.zorluk == 'Kolay' %}bg-green-100 text-green-700
                                    {% elif soru.zorluk == 'Zor' %}bg-red-100 text-red-700
                                    {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                                {{ soru.zorluk }}
                            </span>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-bold bg-orange-100 text-orange-700">
                            {{ soru.puan }} Puan
                        </span>
                    </div>
                    <p class="text-slate-800 font-medium text-sm line-clamp-2">{{ soru.soru_metni }}</p>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-12">
                    <i data-lucide="inbox" class="w-16 h-16 mx-auto text-slate-300 mb-4"></i>
                    <p class="text-slate-500">HenÃ¼z soru bulunmuyor</p>
                    <a href="/soru-bankasi" class="text-purple-600 hover:text-purple-700 font-medium mt-2 inline-block">
                        Soru eklemek iÃ§in tÄ±klayÄ±n
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- SOL PANEL: Ayarlar ve Butonlar (4 Col - %40 KÃ¼Ã§Ã¼ltÃ¼ldÃ¼) -->
    <div class="lg:col-span-4 space-y-2 lg:sticky lg:top-4 self-start" style="zoom: 0.6;">

        <!-- SÄ±nav Bilgileri -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="gradient-success p-4 text-white">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="file-text" class="w-6 h-6"></i>
                    SÄ±nav Bilgileri
                </h2>
            </div>
            <div class="p-3 space-y-2">
                <!-- 1. Antet LogolarÄ± (KaÄŸÄ±dÄ±n en Ã¼stÃ¼) -->
                <div class="border-b border-slate-200 pb-4">
                    <h3 class="text-sm font-bold text-slate-700 mb-3">Antet LogolarÄ±</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Sol Logo -->
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Sol Ãœst Logo</label>
                            <div class="relative group border-2 border-dashed border-slate-300 rounded-lg p-2 text-center hover:bg-slate-50 hover:border-purple-300 transition-all h-24 flex items-center justify-center cursor-pointer"
                                onclick="document.getElementById('solLogoInput').click()">
                                <input type="file" id="solLogoInput" class="hidden" accept="image/*"
                                    onchange="logoYukle(this, 'sol')">
                                <input type="hidden" id="sinavLogoSol">
                                <div id="solLogoPlaceholder">
                                    <i data-lucide="upload"
                                        class="w-6 h-6 mx-auto text-slate-400 group-hover:text-purple-500"></i>
                                    <span class="text-xs text-slate-400 group-hover:text-purple-500 block mt-1">Logo
                                        SeÃ§</span>
                                </div>
                                <div id="solLogoPreviewContainer"
                                    class="hidden absolute inset-0 bg-white rounded-lg flex items-center justify-center p-1 border border-slate-200">
                                    <img id="solLogoPreview" class="max-h-full max-w-full object-contain">
                                    <button type="button" onclick="event.stopPropagation(); logoSil('sol')"
                                        class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-all z-10"><i
                                            data-lucide="x" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                        </div>
                        <!-- SaÄŸ Logo -->
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">SaÄŸ Ãœst Logo</label>
                            <div class="relative group border-2 border-dashed border-slate-300 rounded-lg p-2 text-center hover:bg-slate-50 hover:border-purple-300 transition-all h-24 flex items-center justify-center cursor-pointer"
                                onclick="document.getElementById('sagLogoInput').click()">
                                <input type="file" id="sagLogoInput" class="hidden" accept="image/*"
                                    onchange="logoYukle(this, 'sag')">
                                <input type="hidden" id="sinavLogoSag">
                                <div id="sagLogoPlaceholder">
                                    <i data-lucide="upload"
                                        class="w-6 h-6 mx-auto text-slate-400 group-hover:text-purple-500"></i>
                                    <span class="text-xs text-slate-400 group-hover:text-purple-500 block mt-1">Logo
                                        SeÃ§</span>
                                </div>
                                <div id="sagLogoPreviewContainer"
                                    class="hidden absolute inset-0 bg-white rounded-lg flex items-center justify-center p-1 border border-slate-200">
                                    <img id="sagLogoPreview" class="max-h-full max-w-full object-contain">
                                    <button type="button" onclick="event.stopPropagation(); logoSil('sag')"
                                        class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-all z-10"><i
                                            data-lucide="x" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Boyut AyarÄ± -->
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-slate-700 mb-2 flex justify-between">
                            <span>Logo Boyutu (px)</span>
                            <span class="text-slate-500" id="logoBoyutLabel">80px</span>
                        </label>
                        <input type="range" id="sinavLogoBoyutu" min="40" max="250" value="80"
                            class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-purple-600"
                            oninput="document.getElementById('logoBoyutLabel').textContent = this.value + 'px'">
                    </div>
                </div>

                <!-- 2. Okul AdÄ± -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Okul AdÄ± (KaÄŸÄ±tta GÃ¶rÃ¼necek)</label>
                    <div class="flex gap-2">
                        <input type="text" id="sinavOkulAdi"
                            placeholder="{{ ayarlar.okul_adi if ayarlar else 'Okul AdÄ± Giriniz' }}"
                            class="flex-1 px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                        <div class="w-24 relative group" title="YazÄ± Boyutu (px)">
                            <input type="number" id="sinavOkulAdiBoyutu" value="18" min="12" max="72"
                                class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all text-center">
                            <div
                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 bg-slate-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
                                Boyut (px)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. EÄŸitim YÄ±lÄ± ve DÃ¶nem -->
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">EÄŸitim - Ã–ÄŸretim YÄ±lÄ±</label>
                        <div class="flex gap-2">
                            <input type="text" id="sinavEgitimYili" value="{{ ayarlar.egitim_yili }}"
                                placeholder="Ã–rn: 2025-2026"
                                class="flex-1 px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                            <div class="w-20 relative group" title="YazÄ± Boyutu (px)">
                                <input type="number" id="sinavEgitimYiliBoyutu" value="16" min="10" max="48"
                                    class="w-full px-2 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all text-center">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">DÃ¶nem / YazÄ±lÄ± Bilgisi</label>
                        <div class="flex gap-2">
                            <input type="text" id="sinavDonem" value="{{ ayarlar.donem }}"
                                placeholder="Ã–rn: 1. DÃ¶nem Final SÄ±navÄ±"
                                class="flex-1 px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                            <div class="w-20 relative group" title="YazÄ± Boyutu (px)">
                                <input type="number" id="sinavDonemBoyutu" value="14" min="10" max="48"
                                    class="w-full px-2 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all text-center">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. SÄ±nav BaÅŸlÄ±ÄŸÄ± -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">SÄ±nav BaÅŸlÄ±ÄŸÄ±</label>
                    <div class="flex gap-2">
                        <input type="text" id="sinavBaslik" placeholder="Ã–rn: Matematik 1. DÃ¶nem SÄ±navÄ±"
                            class="flex-1 px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <div class="w-24 relative group" title="YazÄ± Boyutu (px)">
                            <input type="number" id="sinavBaslikBoyutu" value="10" min="10" max="64"
                                class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all text-center">
                        </div>
                    </div>
                </div>

                <!-- 5. Tarih ve Saat -->
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">SÄ±nav Tarihi</label>
                        <input type="date" id="sinavTarih"
                            class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">SÄ±nav Saati</label>
                        <div class="flex items-center gap-2">
                            <div class="relative w-full">
                                <input type="time" id="sinavSaatBaslangic"
                                    class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all text-center">
                                <div
                                    class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                    <i data-lucide="clock" class="w-4 h-4"></i>
                                </div>
                            </div>
                            <span class="text-slate-400 font-bold">-</span>
                            <div class="relative w-full">
                                <input type="time" id="sinavSaatBitis"
                                    class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all text-center">
                                <div
                                    class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                    <i data-lucide="clock" class="w-4 h-4"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. AÃ§Ä±klama -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">AÃ§Ä±klama (Opsiyonel)</label>
                    <textarea id="sinavAciklama" rows="2" placeholder="SÄ±nav hakkÄ±nda notlar..."
                        class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none"></textarea>
                </div>

                <!-- 7. Ä°mza Metni -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Ä°mza Metni</label>
                    <input type="text" id="sinavImzaMetni"
                        value="{{ ayarlar.imza_metni if ayarlar else 'Ã–ÄŸr.GÃ¶r.Erdem ALPAR' }}"
                        class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                </div>

                <!-- 8. Stil AyarlarÄ± -->
                <div class="border-t border-slate-200 pt-4 mt-2">
                    <h3 class="text-sm font-bold text-slate-700 mb-3">KÃ¢ÄŸÄ±t Stili & Ayarlar</h3>
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <!-- YazÄ± Tipi -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">YazÄ± Tipi</label>
                            <select id="sinavYaziFontu"
                                class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                                <option value="font-sans">Arial / Sans Serif</option>
                                <option value="font-serif">Times New Roman / Serif</option>
                                <option value="font-mono">Courier / Monospace</option>
                            </select>
                        </div>
                        <!-- YazÄ± Boyutu -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">YazÄ± Boyutu (px)</label>
                            <input type="number" id="sinavYaziBoyutu" value="8" min="4" max="24"
                                class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <!-- YazÄ± Rengi -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">YazÄ± Rengi</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="sinavYaziRengi" value="#000000"
                                    class="h-10 w-full cursor-pointer rounded-lg border-2 border-slate-200 p-1">
                            </div>
                        </div>
                        <!-- YazÄ± Stili -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">YazÄ± Stili</label>
                            <select id="sinavYaziStili"
                                class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                                <option value="normal">Normal</option>
                                <option value="bold">KalÄ±n (Bold)</option>
                            </select>
                        </div>
                    </div>
                    <!-- Resim Boyutu -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2 flex justify-between">
                            <span>GÃ¶rsel Boyutu (Sorulardaki Resimler)</span>
                            <span class="text-slate-500" id="gorselBoyutuLabel">%100</span>
                        </label>
                        <input type="range" id="sinavGorselBoyutu" min="20" max="100" value="100"
                            class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-purple-600"
                            oninput="document.getElementById('gorselBoyutuLabel').textContent = '%' + this.value">
                    </div>
                    <!-- Puan Kutusu Boyutu -->
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2 flex justify-between">
                            <span>Puan Kutusu Boyutu</span>
                            <span class="text-slate-500" id="puanKutusuBoyutuLabel">%{{ eski_sinav.puan_kutusu_boyutu if
                                eski_sinav else '40' }}</span>
                        </label>
                        <input type="range" id="sinavPuanKutusuBoyutu" min="10" max="150"
                            value="{{ eski_sinav.puan_kutusu_boyutu if eski_sinav else '40' }}"
                            class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-purple-600"
                            oninput="document.getElementById('puanKutusuBoyutuLabel').textContent = '%' + this.value">
                    </div>
                    <input type="hidden" id="sinavSikBoslugu"
                        value="{{ eski_sinav.sik_boslugu if eski_sinav else '16' }}">
                    <input type="hidden" id="sinavSikBoslugu"
                        value="{{ eski_sinav.sik_boslugu if eski_sinav else '16' }}">
                </div>
            </div>
        </div>

        <!-- Eylem ButonlarÄ± sidebar'a taÅŸÄ±ndÄ± -->
    </div>
</div>

<script>
    let secilenSorular = new Set();

    function soruSec(soruId, element) {
        const checkbox = element.querySelector('.soru-checkbox');

        if (secilenSorular.has(soruId)) {
            secilenSorular.delete(soruId);
            element.classList.remove('soru-secili');
            checkbox.checked = false;
        } else {
            secilenSorular.add(soruId);
            element.classList.add('soru-secili');
            checkbox.checked = true;
        }

        secilenSorulariGuncelle();
    }

    function secilenSorulariGuncelle() {
        const liste = document.getElementById('secilenSorularListe');
        liste.innerHTML = '';

        if (secilenSorular.size === 0) {
            liste.innerHTML = `
                <div class="text-center w-full py-2 text-slate-400 flex items-center justify-center gap-2">
                    <i data-lucide="mouse-pointer-click" class="w-5 h-5"></i>
                    <p class="text-sm font-medium">Soru bankasÄ±ndan soru seÃ§erek baÅŸlayÄ±n</p>
                </div>
            `;
            lucide.createIcons();
            return;
        }

        let toplamPuan = 0;
        secilenSorular.forEach((soruId, index) => {
            const soruKart = document.querySelector(`[data-soru-id="${soruId}"]`);
            if (!soruKart) return; // Filtreleme durumunda DOM'da olmayabilir

            const puanText = soruKart.querySelector('.bg-orange-100')?.textContent || "0";
            const puan = parseInt(puanText);
            toplamPuan += puan;

            const chip = document.createElement('div');
            chip.className = 'group flex items-center gap-2 bg-white border border-slate-200 pl-2 pr-1 py-1 rounded-xl shadow-sm hover:border-indigo-300 hover:shadow-md transition-all shrink-0';
            chip.innerHTML = `
                <span class="w-5 h-5 rounded-lg bg-indigo-600 text-white text-[10px] flex items-center justify-center font-bold">${index + 1}</span>
                <span class="text-xs font-bold text-slate-700">#${soruId}</span>
                <span class="text-[10px] bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded font-bold">${puan}p</span>
                <button onclick="soruCikar(${soruId})" class="p-1 rounded-lg text-slate-300 hover:bg-red-50 hover:text-red-500 transition-colors">
                    <i data-lucide="x" class="w-3.5 h-3.5"></i>
                </button>
            `;
            liste.appendChild(chip);
        });

        // Ä°statistikleri gÃ¼ncelle
        document.getElementById('toplamSoruSayisi').textContent = secilenSorular.size;
        document.getElementById('toplamPuan').textContent = toplamPuan;
        document.getElementById('ortalamaPuan').textContent = secilenSorular.size > 0 ?
            (toplamPuan / secilenSorular.size).toFixed(1) : 0;

        lucide.createIcons();
    }

    function soruCikar(soruId) {
        const soruKart = document.querySelector(`[data-soru-id="${soruId}"]`);
        if (soruKart) {
            soruKart.click();
        }
    }

    async function tumSorulariTemizle() {
        if (secilenSorular.size === 0) return;

        const result = await Swal.fire({
            title: 'TÃ¼mÃ¼nÃ¼ Temizle?',
            text: "SeÃ§tiÄŸiniz tÃ¼m sorular listeden kaldÄ±rÄ±lacaktÄ±r.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'Evet, Temizle',
            cancelButtonText: 'VazgeÃ§'
        });

        if (result.isConfirmed) {
            document.querySelectorAll('.soru-secili').forEach(el => {
                el.classList.remove('soru-secili');
                const cb = el.querySelector('.soru-checkbox');
                if (cb) cb.checked = false;
            });
            secilenSorular.clear();
            secilenSorulariGuncelle();
            toastGoster('Liste temizlendi', 'info');
        }
    }

    async function sinavKaydet() {
        // UI ile Set senkronizasyonu (Garantilemek iÃ§in)
        document.querySelectorAll('.soru-checkbox:checked').forEach(checkbox => {
            const soruId = parseInt(checkbox.dataset.soruId);
            if (!isNaN(soruId)) {
                secilenSorular.add(soruId);
            }
        });

        if (secilenSorular.size === 0) {
            toastGoster('LÃ¼tfen en az bir soru seÃ§in', 'warning');
            return;
        }

        const baslik = document.getElementById('sinavBaslik').value;
        // BaÅŸlÄ±k zorunluluÄŸu kaldÄ±rÄ±ldÄ±
        /*
        if (!baslik) {
            toastGoster('LÃ¼tfen sÄ±nav baÅŸlÄ±ÄŸÄ± girin', 'warning');
            return;
        }
        */

        const sinavData = {
            baslik: baslik,
            aciklama: document.getElementById('sinavAciklama').value,
            egitim_yili: document.getElementById('sinavEgitimYili').value,
            donem: document.getElementById('sinavDonem').value,
            tarih: document.getElementById('sinavTarih').value,
            tarih: document.getElementById('sinavTarih').value,
            saat: (document.getElementById('sinavSaatBaslangic').value && document.getElementById('sinavSaatBitis').value)
                ? (document.getElementById('sinavSaatBaslangic').value + ' - ' + document.getElementById('sinavSaatBitis').value)
                : (document.getElementById('sinavSaatBaslangic').value || document.getElementById('sinavSaatBitis').value || ''),
            okul_adi: document.getElementById('sinavOkulAdi').value,
            okul_adi: document.getElementById('sinavOkulAdi').value,
            okul_adi_boyutu: document.getElementById('sinavOkulAdiBoyutu').value,
            egitim_yili_boyutu: document.getElementById('sinavEgitimYiliBoyutu').value,
            donem_boyutu: document.getElementById('sinavDonemBoyutu').value,
            baslik_boyutu: document.getElementById('sinavBaslikBoyutu').value,
            imza_metni: document.getElementById('sinavImzaMetni').value,
            yazi_fontu: document.getElementById('sinavYaziFontu').value,
            yazi_boyutu: document.getElementById('sinavYaziBoyutu').value,
            yazi_rengi: document.getElementById('sinavYaziRengi').value,
            yazi_stili: document.getElementById('sinavYaziStili').value,
            gorsel_boyutu: document.getElementById('sinavGorselBoyutu').value,
            yazi_stili: document.getElementById('sinavYaziStili').value,
            gorsel_boyutu: document.getElementById('sinavGorselBoyutu').value,
            gorsel_boyutu: document.getElementById('sinavGorselBoyutu').value,
            puan_kutusu_boyutu: document.getElementById('sinavPuanKutusuBoyutu').value,
            sik_boslugu: document.getElementById('sinavSikBoslugu').value,
            logo_sol: document.getElementById('sinavLogoSol').value,
            logo_sag: document.getElementById('sinavLogoSag').value,
            logo_boyutu: document.getElementById('sinavLogoBoyutu').value,
            soru_idleri: Array.from(secilenSorular)
        };

        try {
            const data = await apiIstegi('/sinav-kaydet', {
                method: 'POST',
                body: JSON.stringify(sinavData)
            });

            toastGoster('SÄ±nav baÅŸarÄ±yla kaydedildi!', 'success');

            if (typeof logger !== 'undefined') {
                logger.basarili('SÄ±nav Kaydedildi', {
                    sinav_id: data.sinav_id,
                    zaman: new Date().toLocaleString('tr-TR')
                });
            }

            // Ã–nizleme sayfasÄ±na yÃ¶nlendir
            setTimeout(() => {
                window.location.href = `/sinav-onizleme/${data.sinav_id}`;
            }, 1000);
        } catch (error) {
            console.error('Hata:', error);
        }
    }

    async function sinavOnizle() {
        if (secilenSorular.size === 0) {
            toastGoster('LÃ¼tfen en az bir soru seÃ§in', 'warning');
            return;
        }

        // Ã–nce kaydet, sonra Ã¶nizle
        await sinavKaydet();
    }

    async function yeniSinav() {
        if (secilenSorular.size > 0) {
            const result = await Swal.fire({
                title: 'Yeni SÄ±nav OluÅŸturulsun mu?',
                text: "Mevcut seÃ§imleriniz (seÃ§ilen sorular vb.) kaybolacaktÄ±r. Yeni bir sayfa aÃ§mak istediÄŸinize emin misiniz?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Evet, SÄ±fÄ±rla',
                cancelButtonText: 'VazgeÃ§'
            });

            if (result.isConfirmed) {
                location.reload();
            }
        } else {
            location.reload();
        }
    }

    // Filtreleme
    document.getElementById('soruAra').addEventListener('input', filtrele);
    document.getElementById('konuFiltre').addEventListener('change', filtrele);
    document.getElementById('zorlukFiltre').addEventListener('change', filtrele);

    function trLower(str) {
        if (!str) return "";
        return str.replace(/Ä°/g, "i").replace(/I/g, "Ä±").toLocaleLowerCase('tr-TR');
    }

    function filtrele() {
        const aramaMetni = trLower(document.getElementById('soruAra').value);
        const konu = document.getElementById('konuFiltre').value;
        const zorluk = document.getElementById('zorlukFiltre').value;

        document.querySelectorAll('.soru-kart').forEach(kart => {
            const soruMetni = trLower(kart.querySelector('p').textContent);
            const soruKonu = kart.dataset.soruKonu;
            const soruZorluk = kart.dataset.soruZorluk;

            const aramaEslesiyor = !aramaMetni || soruMetni.includes(aramaMetni);
            const konuEslesiyor = !konu || soruKonu === konu;
            const zorlukEslesiyor = !zorluk || soruZorluk === zorluk;

            if (aramaEslesiyor && konuEslesiyor && zorlukEslesiyor) {
                kart.style.display = 'block';
            } else {
                kart.style.display = 'none';
            }
        });
    }

    function konuFiltreleriniDoldur() {
        const konuSelects = [document.getElementById('konuFiltre'), document.getElementById('rastgeleKonu')];
        const konular = new Set();

        document.querySelectorAll('.soru-kart').forEach(kart => {
            const konu = kart.dataset.soruKonu;
            if (konu && konu.trim() !== '') {
                konular.add(konu);
            }
        });

        const konuListesi = Array.from(konular).sort();

        konuSelects.forEach((select, index) => {
            if (!select) return;
            const baslik = index === 0 ? 'TÃ¼m Konular' : 'TÃ¼m Konulardan';
            select.innerHTML = `<option value="">${baslik}</option>`;
            konuListesi.forEach(konu => {
                const option = document.createElement('option');
                option.value = konu;
                option.textContent = konu;
                select.appendChild(option);
            });
        });

        logger.bilgi('Konu filtreleri (normal ve rastgele) gÃ¼ncellendi', { konuSayisi: konular.size });
    }

    // Sayfa yÃ¼klendiÄŸinde konularÄ± algÄ±la
    document.addEventListener('DOMContentLoaded', konuFiltreleriniDoldur);

    setTimeout(() => {
        lucide.createIcons();
    }, 100);

    function tumunuSecToggle(checkbox) {
        const checked = checkbox.checked;
        const gorunurKartlar = Array.from(document.querySelectorAll('.soru-kart')).filter(kart => kart.style.display !== 'none');

        gorunurKartlar.forEach(kart => {
            const soruId = parseInt(kart.dataset.soruId);
            const kartCheckbox = kart.querySelector('.soru-checkbox');

            if (checked) {
                // SeÃ§ (eÄŸer seÃ§ili deÄŸilse)
                if (!secilenSorular.has(soruId)) {
                    secilenSorular.add(soruId);
                    kart.classList.add('soru-secili');
                    kartCheckbox.checked = true;
                }
            } else {
                // KaldÄ±r (eÄŸer seÃ§iliyse)
                if (secilenSorular.has(soruId)) {
                    secilenSorular.delete(soruId);
                    kart.classList.remove('soru-secili');
                    kartCheckbox.checked = false;
                }
            }
        });

        secilenSorulariGuncelle();

        // Label GÃ¼ncelleme
        checkbox.nextElementSibling.textContent = checked ? 'TÃ¼mÃ¼nÃ¼ KaldÄ±r' : 'TÃ¼mÃ¼nÃ¼ SeÃ§';

        // Checkbox gÃ¶rsel durumunu gÃ¼ncelle
        const wrapper = checkbox.parentElement;
        if (checked) wrapper.classList.add('checked');
        else wrapper.classList.remove('checked');
    }

    function rastgeleSoruSec() {
        const konu = document.getElementById('rastgeleKonu').value;
        const adet = parseInt(document.getElementById('rastgeleAdet').value) || 0;

        if (adet <= 0) {
            toastGoster('LÃ¼tfen geÃ§erli bir sayÄ± girin', 'warning');
            return;
        }

        // Havuzdaki uygun sorularÄ± bul
        let adaySorular = Array.from(document.querySelectorAll('.soru-kart')).filter(kart => {
            const soruKonu = kart.dataset.soruKonu;
            const soruId = parseInt(kart.dataset.soruId);
            const zatenSecili = secilenSorular.has(soruId);

            if (zatenSecili) return false; // Zaten seÃ§ilmiÅŸleri ele
            if (konu === "") return true; // TÃ¼m konulardan
            return soruKonu === konu; // Sadece seÃ§ili konudan
        });

        if (adaySorular.length === 0) {
            toastGoster('SeÃ§ilebilecek uygun soru bulunamadÄ±', 'info');
            return;
        }

        // KarÄ±ÅŸtÄ±r
        adaySorular.sort(() => Math.random() - 0.5);

        // SeÃ§ilecek gerÃ§ek adet
        const secilecekAdet = Math.min(adet, adaySorular.length);
        const secilenler = adaySorular.slice(0, secilecekAdet);

        // UI'da seÃ§
        secilenler.forEach(kart => {
            const soruId = parseInt(kart.dataset.soruId);
            soruSec(soruId, kart);
        });

        toastGoster(`${secilecekAdet} adet rastgele soru eklendi`, 'success');

        if (secilecekAdet < adet) {
            setTimeout(() => {
                toastGoster(`Not: Havuzda sadece ${secilecekAdet} uygun soru vardÄ±.`, 'info');
            }, 1000);
        }
    }


    // Logo YÃ¼kleme
    async function logoYukle(input, side) { // side: 'sol' veya 'sag'
        if (input.files && input.files[0]) {
            const formData = new FormData();
            formData.append('gorsel', input.files[0]);

            try {
                const response = await fetch('/gorsel-yukle', { method: 'POST', body: formData });
                const data = await response.json();

                if (data.basarili) {
                    const path = data.dosya_yolu;
                    document.getElementById(side === 'sol' ? 'sinavLogoSol' : 'sinavLogoSag').value = path;

                    const preview = document.getElementById(side === 'sol' ? 'solLogoPreview' : 'sagLogoPreview');
                    preview.src = path;

                    document.getElementById(side === 'sol' ? 'solLogoPlaceholder' : 'sagLogoPlaceholder').classList.add('hidden');
                    document.getElementById(side === 'sol' ? 'solLogoPreviewContainer' : 'sagLogoPreviewContainer').classList.remove('hidden');

                    if (window.lucide) lucide.createIcons();
                } else {
                    toastGoster(data.mesaj, 'error');
                }
            } catch (error) {
                console.error(error);
                toastGoster('Logo yÃ¼klenirken hata oluÅŸtu', 'error');
            }
        }
    }

    function logoSil(side) {
        document.getElementById(side === 'sol' ? 'solLogoInput' : 'sagLogoInput').value = '';
        document.getElementById(side === 'sol' ? 'sinavLogoSol' : 'sinavLogoSag').value = '';

        document.getElementById(side === 'sol' ? 'solLogoPlaceholder' : 'sagLogoPlaceholder').classList.remove('hidden');
        document.getElementById(side === 'sol' ? 'solLogoPreviewContainer' : 'sagLogoPreviewContainer').classList.add('hidden');
        document.getElementById(side === 'sol' ? 'solLogoPreview' : 'sagLogoPreview').src = '';
    }

    // EÄŸer dÃ¼zenleme modundaysak (eski_sinav varsa) verileri doldur
    {% if eski_sinav %}
    document.addEventListener('DOMContentLoaded', () => {
        // Form Verileri
        document.getElementById('sinavBaslik').value = "{{ eski_sinav.baslik }}";

        // Ã‡ok satÄ±rlÄ± metni JS stringine gÃ¼venli aktarmak iÃ§in escape
        const aciklama = `{{ eski_sinav.aciklama or '' }}`;
        document.getElementById('sinavAciklama').value = aciklama;

        document.getElementById('sinavEgitimYili').value = "{{ eski_sinav.egitim_yili or '' }}";
        document.getElementById('sinavDonem').value = "{{ eski_sinav.donem or '' }}";
        document.getElementById('sinavTarih').value = "{{ eski_sinav.tarih or '' }}";

        const saatVal = "{{ eski_sinav.saat or '' }}";
        if (saatVal.includes(' - ')) {
            const parts = saatVal.split(' - ');
            document.getElementById('sinavSaatBaslangic').value = parts[0];
            document.getElementById('sinavSaatBitis').value = parts[1];
        } else {
            document.getElementById('sinavSaatBaslangic').value = saatVal;
        }

        document.getElementById('sinavOkulAdi').value = "{{ eski_sinav.okul_adi or '' }}";
        document.getElementById('sinavOkulAdiBoyutu').value = "{{ eski_sinav.okul_adi_boyutu or 24 }}";
        document.getElementById('sinavEgitimYiliBoyutu').value = "{{ eski_sinav.egitim_yili_boyutu or 18 }}";
        document.getElementById('sinavDonemBoyutu').value = "{{ eski_sinav.donem_boyutu or 16 }}";
        document.getElementById('sinavBaslikBoyutu').value = "{{ eski_sinav.baslik_boyutu or 16 }}";
        document.getElementById('sinavImzaMetni').value = "{{ eski_sinav.imza_metni or '' }}";

        // GÃ¶rÃ¼nÃ¼m AyarlarÄ±
        document.getElementById('sinavYaziFontu').value = "{{ eski_sinav.yazi_fontu or 'font-sans' }}";
        document.getElementById('sinavYaziBoyutu').value = "{{ eski_sinav.yazi_boyutu or 12 }}";
        document.getElementById('sinavYaziRengi').value = "{{ eski_sinav.yazi_rengi or '#000000' }}";
        document.getElementById('sinavYaziStili').value = "{{ eski_sinav.yazi_stili or 'normal' }}";

        document.getElementById('sinavGorselBoyutu').value = "{{ eski_sinav.gorsel_boyutu or 100 }}";
        document.getElementById('gorselBoyutuLabel').textContent = '%' + "{{ eski_sinav.gorsel_boyutu or 100 }}";

        // Logo AyarlarÄ±
        const logoSol = "{{ eski_sinav.logo_sol or '' }}";
        const logoSag = "{{ eski_sinav.logo_sag or '' }}";

        if (logoSol) {
            document.getElementById('sinavLogoSol').value = logoSol;
            const solPreview = document.getElementById('solLogoPreview');
            if (solPreview) solPreview.src = logoSol;
            document.getElementById('solLogoPlaceholder').classList.add('hidden');
            document.getElementById('solLogoPreviewContainer').classList.remove('hidden');
        }

        if (logoSag) {
            document.getElementById('sinavLogoSag').value = logoSag;
            const sagPreview = document.getElementById('sagLogoPreview');
            if (sagPreview) sagPreview.src = logoSag;
            document.getElementById('sagLogoPlaceholder').classList.add('hidden');
            document.getElementById('sagLogoPreviewContainer').classList.remove('hidden');
        }

        document.getElementById('sinavLogoBoyutu').value = "{{ eski_sinav.logo_boyutu or 80 }}";
        document.getElementById('logoBoyutLabel').textContent = "{{ eski_sinav.logo_boyutu or 80 }}px";

        // SorularÄ± SeÃ§
        // Jinja2 ile soru ID'lerini listeye Ã§evirip JS'e aktaralÄ±m
        const seciliSoruIdleri = [
            {% for sinav_sorusu in eski_sinav.sorular %}
                {{ sinav_sorusu.soru_id }},
        {% endfor %}
        ];

    seciliSoruIdleri.forEach(soruId => {
        const soruKart = document.querySelector(`.soru-kart[data-soru-id="${soruId}"]`);
        if (soruKart) {
            // Manuel seÃ§im fonksiyonunu taklit etmeden doÄŸrudan durumu gÃ¼ncelle
            secilenSorular.add(soruId);
            soruKart.classList.add('soru-secili');
            const checkbox = soruKart.querySelector('.soru-checkbox');
            if (checkbox) checkbox.checked = true;
        }
    });

    // Listeyi gÃ¼ncelle
    secilenSorulariGuncelle();
    });
    {% endif %}

</script>
{% endblock %}