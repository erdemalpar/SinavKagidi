{% extends "base.html" %}

{% block title %}Sınav Hazırla - Sınav Kağıdı Hazırlama{% endblock %}

{% block extra_styles %}
<style>
    .soru-secili {
        border-color: #667eea;
        background: linear-gradient(135deg, #f3f4f6 0%, #e0e7ff 100%);
    }

    .drag-over {
        border-color: #10b981;
        background-color: #d1fae5;
    }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Sol Panel - Soru Bankası -->
    <div class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="gradient-primary p-6 text-white">
                <h1 class="text-2xl font-bold flex items-center gap-3">
                    <i data-lucide="database" class="w-7 h-7"></i>
                    Soru Bankası
                </h1>
                <p class="text-sm opacity-90 mt-1">Eklemek istediğiniz soruları seçin</p>
            </div>

            <!-- Filtreler -->
            <div class="p-4 bg-slate-50 border-b border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" id="soruAra" placeholder="Soru ara..."
                        class="px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none">
                    <select id="konuFiltre"
                        class="px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <option value="">Tüm Konular</option>
                    </select>
                    <select id="zorlukFiltre"
                        class="px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none">
                        <option value="">Tüm Zorluklar</option>
                        <option value="Kolay">Kolay</option>
                        <option value="Orta">Orta</option>
                        <option value="Zor">Zor</option>
                    </select>
                </div>
            </div>

            <!-- Sorular Listesi -->
            <div class="p-6 space-y-4 max-h-[600px] overflow-y-auto">
                {% if sorular %}
                {% for soru in sorular %}
                <div class="soru-kart border-2 border-slate-200 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all"
                    data-soru-id="{{ soru.id }}" data-soru-konu="{{ soru.konu or '' }}"
                    data-soru-zorluk="{{ soru.zorluk }}" onclick="soruSec({{ soru.id }}, this)">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center">
                                <input type="checkbox" class="soru-checkbox w-4 h-4" data-soru-id="{{ soru.id }}">
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                                #{{ soru.id }}
                            </span>
                            {% if soru.konu %}
                            <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                {{ soru.konu }}
                            </span>
                            {% endif %}
                            <span class="px-2 py-1 rounded-full text-xs font-medium 
                                    {% if soru.zorluk == 'Kolay' %}bg-green-100 text-green-700
                                    {% elif soru.zorluk == 'Zor' %}bg-red-100 text-red-700
                                    {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                                {{ soru.zorluk }}
                            </span>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-bold bg-orange-100 text-orange-700">
                            {{ soru.puan }} Puan
                        </span>
                    </div>
                    <p class="text-slate-800 font-medium text-sm line-clamp-2">{{ soru.soru_metni }}</p>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-12">
                    <i data-lucide="inbox" class="w-16 h-16 mx-auto text-slate-300 mb-4"></i>
                    <p class="text-slate-500">Henüz soru bulunmuyor</p>
                    <a href="/soru-bankasi" class="text-purple-600 hover:text-purple-700 font-medium mt-2 inline-block">
                        Soru eklemek için tıklayın
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sağ Panel - Seçilen Sorular ve Sınav Ayarları -->
    <div class="space-y-6">
        <!-- Sınav Bilgileri -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="gradient-success p-4 text-white">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="file-text" class="w-6 h-6"></i>
                    Sınav Bilgileri
                </h2>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Sınav Başlığı</label>
                    <input type="text" id="sinavBaslik" placeholder="Örn: Matematik 1. Dönem Sınavı"
                        class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Açıklama (Opsiyonel)</label>
                    <textarea id="sinavAciklama" rows="2" placeholder="Sınav hakkında notlar..."
                        class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Sınav Tarihi</label>
                    <input type="date" id="sinavTarih" 
                        class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                </div>
            </div>
        </div>

        <!-- Seçilen Sorular -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="gradient-warning p-4 text-white">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="list-checks" class="w-6 h-6"></i>
                    Seçilen Sorular
                </h2>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <p class="text-2xl font-bold text-blue-600" id="toplamSoruSayisi">0</p>
                        <p class="text-xs text-slate-600">Soru</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <p class="text-2xl font-bold text-green-600" id="toplamPuan">0</p>
                        <p class="text-xs text-slate-600">Puan</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg">
                        <p class="text-2xl font-bold text-purple-600" id="ortalamaPuan">0</p>
                        <p class="text-xs text-slate-600">Ort.</p>
                    </div>
                </div>

                <div id="secilenSorularListe" class="space-y-2 max-h-64 overflow-y-auto">
                    <div class="text-center py-8 text-slate-400">
                        <i data-lucide="mouse-pointer-click" class="w-12 h-12 mx-auto mb-2"></i>
                        <p class="text-sm">Soldan soru seçin</p>
                    </div>
                </div>

                <button onclick="tumSorulariTemizle()"
                    class="w-full mt-4 px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg font-medium transition-all">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                    Tümünü Temizle
                </button>
            </div>
        </div>

        <!-- Eylem Butonları -->
        <div class="bg-white rounded-2xl shadow-lg p-4 space-y-3">
            <button onclick="sinavKaydet()"
                class="w-full gradient-primary text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all hover:scale-105">
                <i data-lucide="save" class="w-5 h-5 inline mr-2"></i>
                Sınavı Kaydet
            </button>
            <button onclick="sinavOnizle()"
                class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all hover:scale-105">
                <i data-lucide="eye" class="w-5 h-5 inline mr-2"></i>
                Önizle & PDF
            </button>
            <button onclick="yeniSinav()"
                class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 px-6 py-3 rounded-lg font-medium transition-all">
                <i data-lucide="refresh-cw" class="w-5 h-5 inline mr-2"></i>
                Yeni Sınav
            </button>
        </div>
    </div>
</div>

<script>
    let secilenSorular = new Set();

    function soruSec(soruId, element) {
        const checkbox = element.querySelector('.soru-checkbox');

        if (secilenSorular.has(soruId)) {
            secilenSorular.delete(soruId);
            element.classList.remove('soru-secili');
            checkbox.checked = false;
        } else {
            secilenSorular.add(soruId);
            element.classList.add('soru-secili');
            checkbox.checked = true;
        }

        secilenSorulariGuncelle();
    }

    function secilenSorulariGuncelle() {
        const liste = document.getElementById('secilenSorularListe');
        liste.innerHTML = '';

        if (secilenSorular.size === 0) {
            liste.innerHTML = `
                <div class="text-center py-8 text-slate-400">
                    <i data-lucide="mouse-pointer-click" class="w-12 h-12 mx-auto mb-2"></i>
                    <p class="text-sm">Soldan soru seçin</p>
                </div>
            `;
            lucide.createIcons();
            return;
        }

        let toplamPuan = 0;
        secilenSorular.forEach((soruId, index) => {
            const soruKart = document.querySelector(`[data-soru-id="${soruId}"]`);
            const soruMetni = soruKart.querySelector('p').textContent;
            const puanText = soruKart.querySelector('.bg-orange-100').textContent;
            const puan = parseInt(puanText);
            toplamPuan += puan;

            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg';
            item.innerHTML = `
                <div class="flex items-center gap-2 flex-1">
                    <span class="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold">${index + 1}</span>
                    <span class="text-sm text-slate-700 line-clamp-1">#${soruId}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-orange-600">${puan}p</span>
                    <button onclick="soruCikar(${soruId})" class="text-red-500 hover:text-red-700">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            liste.appendChild(item);
        });

        // İstatistikleri güncelle
        document.getElementById('toplamSoruSayisi').textContent = secilenSorular.size;
        document.getElementById('toplamPuan').textContent = toplamPuan;
        document.getElementById('ortalamaPuan').textContent = secilenSorular.size > 0 ?
            (toplamPuan / secilenSorular.size).toFixed(1) : 0;

        lucide.createIcons();
    }

    function soruCikar(soruId) {
        const soruKart = document.querySelector(`[data-soru-id="${soruId}"]`);
        if (soruKart) {
            soruKart.click();
        }
    }

    function tumSorulariTemizle() {
        if (secilenSorular.size === 0) return;

        if (confirm('Tüm seçili soruları temizlemek istediğinizden emin misiniz?')) {
            document.querySelectorAll('.soru-secili').forEach(el => {
                el.classList.remove('soru-secili');
                el.querySelector('.soru-checkbox').checked = false;
            });
            secilenSorular.clear();
            secilenSorulariGuncelle();
        }
    }

    async function sinavKaydet() {
        if (secilenSorular.size === 0) {
            toastGoster('Lütfen en az bir soru seçin', 'warning');
            return;
        }

        const baslik = document.getElementById('sinavBaslik').value;
        if (!baslik) {
            toastGoster('Lütfen sınav başlığı girin', 'warning');
            return;
        }

        const sinavData = {
            baslik: baslik,
            aciklama: document.getElementById('sinavAciklama').value,
            tarih: document.getElementById('sinavTarih').value,
            soru_idleri: Array.from(secilenSorular)
        };

        try {
            const data = await apiIstegi('/sinav-kaydet', {
                method: 'POST',
                body: JSON.stringify(sinavData)
            });

            toastGoster('Sınav başarıyla kaydedildi!', 'success');

            // Önizleme sayfasına yönlendir
            setTimeout(() => {
                window.location.href = `/sinav-onizleme/${data.sinav_id}`;
            }, 1000);
        } catch (error) {
            console.error('Hata:', error);
        }
    }

    async function sinavOnizle() {
        if (secilenSorular.size === 0) {
            toastGoster('Lütfen en az bir soru seçin', 'warning');
            return;
        }

        // Önce kaydet, sonra önizle
        await sinavKaydet();
    }

    function yeniSinav() {
        if (secilenSorular.size > 0) {
            if (confirm('Mevcut seçimleri kaybedeceksiniz. Devam etmek istiyor musunuz?')) {
                location.reload();
            }
        } else {
            location.reload();
        }
    }

    // Filtreleme
    document.getElementById('soruAra').addEventListener('input', filtrele);
    document.getElementById('konuFiltre').addEventListener('change', filtrele);
    document.getElementById('zorlukFiltre').addEventListener('change', filtrele);

    function filtrele() {
        const aramaMetni = document.getElementById('soruAra').value.toLowerCase();
        const konu = document.getElementById('konuFiltre').value;
        const zorluk = document.getElementById('zorlukFiltre').value;

        document.querySelectorAll('.soru-kart').forEach(kart => {
            const soruMetni = kart.querySelector('p').textContent.toLowerCase();
            const soruKonu = kart.dataset.soruKonu;
            const soruZorluk = kart.dataset.soruZorluk;

            const aramaEslesiyor = !aramaMetni || soruMetni.includes(aramaMetni);
            const konuEslesiyor = !konu || soruKonu === konu;
            const zorlukEslesiyor = !zorluk || soruZorluk === zorluk;

            if (aramaEslesiyor && konuEslesiyor && zorlukEslesiyor) {
                kart.style.display = 'block';
            } else {
                kart.style.display = 'none';
            }
        });
    }

    setTimeout(() => {
        lucide.createIcons();
    }, 100);
</script>
{% endblock %}