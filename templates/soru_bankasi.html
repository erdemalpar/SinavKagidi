{% extends "base.html" %}

{% block title %}Soru Bankasƒ± - Sƒ±nav Kaƒüƒ±dƒ± Hazƒ±rlama

{% endblock %}

{% block content %}
<!-- Updated at 2026-01-04 00:12:57 -->

<div class="space-y-6">
    <!-- Ba≈ülƒ±k ve Eylem Butonlarƒ± -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-4xl font-bold text-slate-800 mb-2">Soru Bankasƒ± üìö</h1>
            <p class="text-slate-600">{{ sorular|length }} soru mevcut</p>
        </div>
        <div class="flex gap-3">
            <button onclick="tumSorulariSil()"
                class="bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 px-6 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all hover:scale-105 border-2 border-red-100">
                <i data-lucide="trash-2" class="w-5 h-5 inline mr-2"></i>
                T√ºm√ºn√º Sil
            </button>
            <button onclick="acDosyaYukleModal()"
                class="bg-white text-slate-700 px-6 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all hover:scale-105 border-2 border-slate-200">
                <i data-lucide="upload" class="w-5 h-5 inline mr-2"></i>
                Dosya Y√ºkle
            </button>
            <button onclick="acSoruEkleModal()"
                class="gradient-primary text-white px-6 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all hover:scale-105">
                <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>
                Yeni Soru Ekle
            </button>
        </div>
    </div>

    <!-- Filtreler -->
    <div class="bg-white rounded-2xl p-6 shadow-lg">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Arama</label>
                <input type="text" id="aramaInput" placeholder="Soru metni ara..."
                    class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Konu</label>
                <select id="konuFiltre"
                    class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                    <option value="">T√ºm Konular</option>
                    {% for konu in konular %}
                    <option value="{{ konu }}">{{ konu }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Zorluk</label>
                <select id="zorlukFiltre"
                    class="w-full px-4 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 focus:outline-none transition-all">
                    <option value="">T√ºm√º</option>
                    {% for zorluk in zorluklar %}
                    <option value="{{ zorluk }}">{{ zorluk }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="filtreleriTemizle()"
                    class="w-full px-4 py-2 bg-slate-50 hover:bg-slate-100 text-slate-600 border border-slate-200 rounded-lg font-medium transition-all flex items-center justify-center gap-2">
                    <i data-lucide="x" class="w-4 h-4"></i>
                    Temizle
                </button>
            </div>
        </div>
    </div>

    <!-- Sorular Listesi -->
    <div id="sorularContainer" class="space-y-4">
        {% if sorular %}
        {% for soru in sorular %}
        <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all soru-kart"
            data-soru-id="{{ soru.id }}" data-konu="{{ soru.konu or '' }}" data-zorluk="{{ soru.zorluk or '' }}">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-700">
                            Soru #{{ soru.id }}
                        </span>
                        {% if soru.konu %}
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-700">
                            {{ soru.konu }}
                        </span>
                        {% endif %}
                        <span class="px-3 py-1 rounded-full text-sm font-medium 
                                {% if soru.zorluk == 'Kolay' %}bg-green-100 text-green-700
                                {% elif soru.zorluk == 'Zor' %}bg-red-100 text-red-700
                                {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                            {{ soru.zorluk }}
                        </span>
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-700">
                            {{ soru.puan }} Puan
                        </span>
                    </div>
                    <p class="text-lg text-slate-800 font-medium mb-3">{{ soru.soru_metni }}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                        {% if soru.secenek_a %}
                        <div
                            class="flex items-center gap-2 p-2 rounded-lg {% if soru.dogru_cevap == 'A' %}bg-green-50 text-green-700 font-medium{% else %}text-slate-600{% endif %}">
                            <span
                                class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center font-bold text-xs">A</span>
                            <span>{{ soru.secenek_a }}</span>
                        </div>
                        {% endif %}
                        {% if soru.secenek_b %}
                        <div
                            class="flex items-center gap-2 p-2 rounded-lg {% if soru.dogru_cevap == 'B' %}bg-green-50 text-green-700 font-medium{% else %}text-slate-600{% endif %}">
                            <span
                                class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center font-bold text-xs">B</span>
                            <span>{{ soru.secenek_b }}</span>
                        </div>
                        {% endif %}
                        {% if soru.secenek_c %}
                        <div
                            class="flex items-center gap-2 p-2 rounded-lg {% if soru.dogru_cevap == 'C' %}bg-green-50 text-green-700 font-medium{% else %}text-slate-600{% endif %}">
                            <span
                                class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center font-bold text-xs">C</span>
                            <span>{{ soru.secenek_c }}</span>
                        </div>
                        {% endif %}
                        {% if soru.secenek_d %}
                        <div
                            class="flex items-center gap-2 p-2 rounded-lg {% if soru.dogru_cevap == 'D' %}bg-green-50 text-green-700 font-medium{% else %}text-slate-600{% endif %}">
                            <span
                                class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center font-bold text-xs">D</span>
                            <span>{{ soru.secenek_d }}</span>
                        </div>
                        {% endif %}
                        {% if soru.secenek_e %}
                        <div
                            class="flex items-center gap-2 p-2 rounded-lg {% if soru.dogru_cevap == 'E' %}bg-green-50 text-green-700 font-medium{% else %}text-slate-600{% endif %}">
                            <span
                                class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center font-bold text-xs">E</span>
                            <span>{{ soru.secenek_e }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="flex flex-col gap-2 ml-4">
                    <button onclick="soruDuzenle({{ soru.id }})"
                        class="p-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg transition-all">
                        <i data-lucide="edit" class="w-5 h-5"></i>
                    </button>
                    <button onclick="soruSil({{ soru.id }})"
                        class="p-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg transition-all">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="bg-white rounded-2xl p-12 text-center shadow-lg">
            <i data-lucide="inbox" class="w-16 h-16 mx-auto text-slate-300 mb-4"></i>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Hen√ºz soru eklenmemi≈ü</h3>
            <p class="text-slate-500 mb-6">Hemen ilk sorunuzu ekleyerek ba≈ülayƒ±n!</p>
            <button onclick="acSoruEkleModal()"
                class="gradient-primary text-white px-6 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all hover:scale-105">
                <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>
                ƒ∞lk Soruyu Ekle
            </button>
        </div>
        {% endif %}
    </div>
</div>


<!-- Soru Ekleme Modalƒ± -->
<div id="soruEkleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
        <div class="gradient-primary p-6 text-white flex items-center justify-between sticky top-0 z-10 shadow-md">
            <h2 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                Yeni Soru Ekle
            </h2>
            <button onclick="kapatSoruEkleModal()"
                class="hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <form id="soruEkleForm" class="p-6 space-y-8">
            <input type="hidden" id="ekleGorselYolu">

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- SOL KOLON -->
                <div class="lg:col-span-8 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Soru Metni *</label>
                        <textarea id="ekleSoruMetni" rows="4"
                            class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 shadow-sm transition-all"
                            placeholder="Soru metnini buraya giriniz..." required></textarea>
                    </div>

                    <!-- ≈ûƒ±klar -->
                    <div class="bg-slate-50 rounded-xl p-5 border border-slate-200">
                        <label class="block text-sm font-bold text-slate-800 mb-4 border-b pb-2">≈ûƒ±klar ve Cevap</label>
                        <div class="space-y-3">

                            <div class="flex items-center gap-3 group">
                                <div
                                    class="w-8 h-8 flex items-center justify-center bg-white border border-slate-300 rounded-full font-bold text-slate-600 group-hover:border-purple-500 group-hover:text-purple-600 transition-colors">
                                    A</div>
                                <input type="text" id="ekleSecenekA"
                                    class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 shadow-sm"
                                    placeholder="A ≈üƒ±kkƒ±">
                                <label class="cursor-pointer">
                                    <input type="radio" name="ekleDogruCevap" value="A" class="peer hidden" checked>
                                    <div
                                        class="w-8 h-8 rounded-full border-2 border-slate-300 peer-checked:bg-green-500 peer-checked:border-green-500 text-white flex items-center justify-center transition-all hover:bg-slate-100">
                                        <i data-lucide="check" class="w-4 h-4 opacity-0 peer-checked:opacity-100"></i>
                                    </div>
                                </label>
                            </div>
                            <div class="flex items-center gap-3 group">
                                <div
                                    class="w-8 h-8 flex items-center justify-center bg-white border border-slate-300 rounded-full font-bold text-slate-600 group-hover:border-purple-500 group-hover:text-purple-600 transition-colors">
                                    B</div>
                                <input type="text" id="ekleSecenekB"
                                    class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 shadow-sm"
                                    placeholder="B ≈üƒ±kkƒ±">
                                <label class="cursor-pointer">
                                    <input type="radio" name="ekleDogruCevap" value="B" class="peer hidden">
                                    <div
                                        class="w-8 h-8 rounded-full border-2 border-slate-300 peer-checked:bg-green-500 peer-checked:border-green-500 text-white flex items-center justify-center transition-all hover:bg-slate-100">
                                        <i data-lucide="check" class="w-4 h-4 opacity-0 peer-checked:opacity-100"></i>
                                    </div>
                                </label>
                            </div>
                            <div class="flex items-center gap-3 group">
                                <div
                                    class="w-8 h-8 flex items-center justify-center bg-white border border-slate-300 rounded-full font-bold text-slate-600 group-hover:border-purple-500 group-hover:text-purple-600 transition-colors">
                                    C</div>
                                <input type="text" id="ekleSecenekC"
                                    class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 shadow-sm"
                                    placeholder="C ≈üƒ±kkƒ±">
                                <label class="cursor-pointer">
                                    <input type="radio" name="ekleDogruCevap" value="C" class="peer hidden">
                                    <div
                                        class="w-8 h-8 rounded-full border-2 border-slate-300 peer-checked:bg-green-500 peer-checked:border-green-500 text-white flex items-center justify-center transition-all hover:bg-slate-100">
                                        <i data-lucide="check" class="w-4 h-4 opacity-0 peer-checked:opacity-100"></i>
                                    </div>
                                </label>
                            </div>
                            <div class="flex items-center gap-3 group">
                                <div
                                    class="w-8 h-8 flex items-center justify-center bg-white border border-slate-300 rounded-full font-bold text-slate-600 group-hover:border-purple-500 group-hover:text-purple-600 transition-colors">
                                    D</div>
                                <input type="text" id="ekleSecenekD"
                                    class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 shadow-sm"
                                    placeholder="D ≈üƒ±kkƒ±">
                                <label class="cursor-pointer">
                                    <input type="radio" name="ekleDogruCevap" value="D" class="peer hidden">
                                    <div
                                        class="w-8 h-8 rounded-full border-2 border-slate-300 peer-checked:bg-green-500 peer-checked:border-green-500 text-white flex items-center justify-center transition-all hover:bg-slate-100">
                                        <i data-lucide="check" class="w-4 h-4 opacity-0 peer-checked:opacity-100"></i>
                                    </div>
                                </label>
                            </div>
                            <div class="flex items-center gap-3 group">
                                <div
                                    class="w-8 h-8 flex items-center justify-center bg-white border border-slate-300 rounded-full font-bold text-slate-600 group-hover:border-purple-500 group-hover:text-purple-600 transition-colors">
                                    E</div>
                                <input type="text" id="ekleSecenekE"
                                    class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 shadow-sm"
                                    placeholder="E ≈üƒ±kkƒ± (Opsiyonel)">
                                <label class="cursor-pointer">
                                    <input type="radio" name="ekleDogruCevap" value="E" class="peer hidden">
                                    <div
                                        class="w-8 h-8 rounded-full border-2 border-slate-300 peer-checked:bg-green-500 peer-checked:border-green-500 text-white flex items-center justify-center transition-all hover:bg-slate-100">
                                        <i data-lucide="check" class="w-4 h-4 opacity-0 peer-checked:opacity-100"></i>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SAƒû KOLON -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- G√∂rsel -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b font-medium text-slate-700 flex items-center gap-2">
                            <i data-lucide="image" class="w-4 h-4 text-purple-600"></i> G√∂rsel
                        </div>
                        <div class="p-4 space-y-4">
                            <div id="ekleGorselArea" class="relative group">
                                <div id="ekleGorselPlaceholder"
                                    class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition-all"
                                    onclick="document.getElementById('ekleGorselInput').click()">
                                    <i data-lucide="upload"
                                        class="w-8 h-8 mx-auto text-slate-400 mb-2 group-hover:text-purple-500"></i>
                                    <span class="text-xs text-slate-500 block">G√∂rsel Y√ºkle</span>
                                </div>
                                <div id="ekleGorselPreviewContainer" class="hidden relative">
                                    <img id="ekleGorselPreviewImg" src=""
                                        class="w-full h-40 object-contain bg-slate-100 rounded-lg border">
                                    <button type="button" onclick="ekleGorselKaldir()"
                                        class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded shadow hover:bg-red-600 transition-all"><i
                                            data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                                <input type="file" id="ekleGorselInput" class="hidden" accept="image/*"
                                    onchange="ekleGorselYukle(this)">
                            </div>
                            <!-- Konum -->
                            <div>
                                <label class="text-xs font-semibold text-slate-500 uppercase mb-1 block">Konum</label>
                                <select id="ekleGorselKonum"
                                    class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-purple-500">
                                    <option value="ustte">‚¨ÜÔ∏è Sorunun √úst√ºnde</option>
                                    <option value="arada">‚ÜïÔ∏è Metin ve ≈ûƒ±klar Arasƒ±nda</option>
                                    <option value="altta">‚¨áÔ∏è ≈ûƒ±klarƒ±n Altƒ±nda</option>
                                    <option value="yanda" selected>‚û°Ô∏è Saƒü Tarafta</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Ayarlar -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b font-medium text-slate-700 flex items-center gap-2">
                            <i data-lucide="settings" class="w-4 h-4 text-blue-600"></i> Ayarlar
                        </div>
                        <div class="p-4 space-y-4">
                            <!-- ≈ûƒ±k D√ºzeni -->
                            <div>
                                <label class="text-xs font-semibold text-slate-500 uppercase mb-1 block">≈ûƒ±k
                                    D√ºzeni</label>
                                <select id="ekleSikDuzeni"
                                    class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-blue-500">
                                    <option value="alt_alta">‚¨áÔ∏è Alt Alta</option>
                                    <option value="yan_yana">‚û°Ô∏è Yan Yana</option>
                                    <option value="iki_sutun" selected>üî≤ ƒ∞ki S√ºtun</option>
                                </select>
                            </div>
                            <!-- Puan -->
                            <div>
                                <label class="text-xs font-semibold text-slate-500 uppercase mb-1 block">Puan</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="eklePuan"
                                        class="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-sm font-bold text-center"
                                        min="1" value="5">
                                    <span class="text-sm text-slate-500">Puan</span>
                                </div>
                            </div>
                            <!-- Zorluk -->
                            <div>
                                <label class="text-xs font-semibold text-slate-500 uppercase mb-1 block">Zorluk</label>
                                <select id="ekleZorluk"
                                    class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                                    <option value="Kolay">üü¢ Kolay</option>
                                    <option value="Orta" selected>üü° Orta</option>
                                    <option value="Zor">üî¥ Zor</option>
                                </select>
                            </div>
                            <!-- Konu -->
                            <div>
                                <label class="text-xs font-semibold text-slate-500 uppercase mb-1 block">Konu</label>
                                <input type="text" id="ekleKonu"
                                    class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm"
                                    placeholder="Konu etiketi">
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="mt-8 border-t pt-6 bg-slate-50 -mx-6 px-6 pb-6">
                <h3 class="text-sm font-bold text-slate-500 uppercase mb-4 flex items-center gap-2 pt-4">
                    <i data-lucide="eye" class="w-4 h-4"></i> Kaƒüƒ±t G√∂r√ºn√ºm√º √ñnizleme
                </h3>
                <div class="bg-white border border-slate-200 p-8 rounded-xl shadow-sm relative overflow-hidden">
                    <div class="absolute inset-0 opacity-[0.02] pointer-events-none"
                        style="background-image: radial-gradient(#000 1px, transparent 1px); background-size: 20px 20px;">
                    </div>
                    <div id="ekleCanliOnizleme" class="relative z-10 font-serif">
                        <p class="text-slate-400 text-center italic">√ñnizleme i√ßin soru verilerini giriniz...</p>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4 border-t border-slate-100">
                <button type="button" onclick="kapatSoruEkleModal()"
                    class="px-6 py-2.5 rounded-lg text-slate-600 hover:bg-slate-100 font-medium transition-all text-sm">ƒ∞ptal</button>
                <button type="submit"
                    class="px-8 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-medium shadow-lg hover:shadow-xl hover:translate-y-[-1px] transition-all text-sm flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> Soru Ekle
                </button>
            </div>
        </form>
    </div>
</div>


<!-- Dosya Y√ºkleme Modalƒ± -->
<div id="dosyaYukleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full shadow-2xl">
        <div class="gradient-success p-6 text-white flex items-center justify-between">
            <h2 class="text-2xl font-bold">Dosya Y√ºkle</h2>
            <button onclick="kapatDosyaYukleModal()"
                class="hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <div class="p-6 space-y-4">
            <div class="border-4 border-dashed border-slate-300 rounded-2xl p-12 text-center hover:border-purple-500 transition-all cursor-pointer"
                onclick="document.getElementById('dosyaInput').click()">
                <i data-lucide="upload-cloud" class="w-16 h-16 mx-auto text-slate-400 mb-4"></i>
                <h3 class="text-lg font-bold text-slate-800 mb-2">Dosya Se√ßin veya S√ºr√ºkleyin</h3>
                <p class="text-sm text-slate-500 mb-4">PDF, DOCX, Excel, JSON veya G√∂rsel (PNG/JPG)</p>
                <input type="file" id="dosyaInput" class="hidden" accept=".pdf,.docx,.xlsx,.xls,.png,.jpg,.jpeg,.json"
                    multiple onchange="dosyaSecildi(this)">
                <button
                    class="gradient-primary text-white px-6 py-2 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all">
                    Dosya Se√ß
                </button>
            </div>

            <div id="dosyaBilgisi" class="hidden bg-blue-50 p-4 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i data-lucide="file" class="w-8 h-8 text-blue-600"></i>
                        <div>
                            <p id="dosyaAdi" class="font-medium text-slate-800"></p>
                            <p id="dosyaBoyutu" class="text-sm text-slate-500"></p>
                        </div>
                    </div>
                </div>
                <button id="dosyaYukleBtn" onclick="dosyaYukle()"
                    class="gradient-success text-white px-6 py-2 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
                    Y√ºkle
                </button>
            </div>
        </div>
    </div>
</div>
</div>

{% include '_soru_guncelle_modal.html' %}

<script>
    let secilenDosyalar = [];

    function acSoruEkleModal() {
        document.getElementById('soruEkleModal').classList.remove('hidden');
        onizlemeGuncelle('ekle');
        onizlemeGuncelle('ekle');
        lucide.createIcons();
    }

    function kapatSoruEkleModal() {
        document.getElementById('soruEkleModal').classList.add('hidden');
        document.getElementById('soruEkleForm').reset();
    }

    function acDosyaYukleModal() {
        document.getElementById('dosyaYukleModal').classList.remove('hidden');
        lucide.createIcons();
    }

    function kapatDosyaYukleModal() {
        document.getElementById('dosyaYukleModal').classList.add('hidden');
        document.getElementById('dosyaBilgisi').classList.add('hidden');
        secilenDosyalar = [];
        document.getElementById('dosyaInput').value = '';
    }

    function dosyaSecildi(input) {
        if (input.files && input.files.length > 0) {
            secilenDosyalar = Array.from(input.files);

            const adiEl = document.getElementById('dosyaAdi');
            const boyutEl = document.getElementById('dosyaBoyutu');

            if (secilenDosyalar.length === 1) {
                adiEl.textContent = secilenDosyalar[0].name;
                boyutEl.textContent = (secilenDosyalar[0].size / 1024 / 1024).toFixed(2) + ' MB';
            } else {
                adiEl.textContent = `${secilenDosyalar.length} dosya se√ßildi`;
                const toplam = secilenDosyalar.reduce((top, f) => top + f.size, 0);
                boyutEl.textContent = `Toplam: ${(toplam / 1024 / 1024).toFixed(2)} MB`;
            }

            document.getElementById('dosyaBilgisi').classList.remove('hidden');
            lucide.createIcons();
        }
    }

    async function dosyaYukle() {
        if (secilenDosyalar.length === 0) {
            logger.uyari('Dosya y√ºkleme iptal edildi', 'Dosya se√ßilmedi');
            return;
        }

        const btn = document.getElementById('dosyaYukleBtn');
        const orjinalMetin = btn.innerHTML;

        try {
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin inline mr-2"></i> Y√ºkleniyor...';
            lucide.createIcons();

            logger.baslik('üìÅ DOSYA Y√úKLEME ƒ∞≈ûLEMƒ∞');
            logger.bilgi(`${secilenDosyalar.length} dosya g√∂nderiliyor...`);

            const formData = new FormData();
            secilenDosyalar.forEach(dosya => {
                formData.append('dosya', dosya);
            });
            const baslamaZamani = performance.now();

            const response = await fetch('/dosya-yukle', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            const bitisZamani = performance.now();
            const sure = Math.round(bitisZamani - baslamaZamani);

            if (data.basarili) {
                logger.basarili(`Dosya ba≈üarƒ±yla y√ºklendi! (${sure}ms)`, {
                    dosya: data.dosya_adi,
                    eklenensoru: data.eklenen_soru_sayisi || 0,
                    hataliSoru: data.hatali_soru_sayisi || 0,
                    tip: data.tip
                });
                toastGoster(data.mesaj || 'Dosya ba≈üarƒ±yla y√ºklendi!', 'success');
                kapatDosyaYukleModal();
                setTimeout(() => location.reload(), 1500);
            } else {
                logger.hata('Dosya y√ºkleme ba≈üarƒ±sƒ±z', {
                    mesaj: data.mesaj,
                    sure: sure + 'ms'
                });
                toastGoster(data.mesaj || 'Dosya y√ºklenirken hata olu≈ütu', 'error');
                btn.disabled = false;
                btn.innerHTML = orjinalMetin;
                lucide.createIcons();
            }
        } catch (error) {
            logger.hata('Dosya y√ºkleme hatasƒ±', error.message);
            toastGoster('Dosya y√ºklenirken hata olu≈ütu', 'error');
            btn.disabled = false;
            btn.innerHTML = orjinalMetin;
            lucide.createIcons();
        }
    }

    document.getElementById('soruEkleForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const soruData = {
            soru_metni: document.getElementById('soruMetni').value,
            secenek_a: document.getElementById('secenekA').value,
            secenek_b: document.getElementById('secenekB').value,
            secenek_c: document.getElementById('secenekC').value,
            secenek_d: document.getElementById('secenekD').value,
            secenek_e: document.getElementById('secenekE').value,
            dogru_cevap: document.getElementById('dogruCevap').value,
            konu: document.getElementById('konu').value,
            zorluk: document.getElementById('zorluk').value,
            puan: parseInt(document.getElementById('puan').value)
        };

        logger.baslik('‚ûï YENƒ∞ SORU EKLEME');
        logger.bilgi('Soru verileri hazƒ±rlandƒ±', soruData);

        try {
            const data = await apiIstegi('/soru-ekle', {
                method: 'POST',
                body: JSON.stringify(soruData)
            });

            logger.basarili('Soru veritabanƒ±na eklendi', { soru_id: data.soru_id });
            toastGoster('Soru ba≈üarƒ±yla eklendi!', 'success');
            kapatSoruEkleModal();
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            logger.hata('Soru ekleme ba≈üarƒ±sƒ±z', error);
        }
    });

    async function soruSil(soruId) {
        if (!confirm('Bu soruyu silmek istediƒüinizden emin misiniz?')) return;

        try {
            const data = await apiIstegi(`/soru-sil/${soruId}`, {
                method: 'DELETE'
            });

            toastGoster('Soru ba≈üarƒ±yla silindi!', 'success');
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            console.error('Hata:', error);
        }
    }

    async function tumSorulariSil() {
        if (!confirm('Dƒ∞KKAT! Soru bankasƒ±ndaki T√úM sorular silinecektir.\nBu i≈ülem geri alƒ±namaz.\n\nEmin misiniz?')) {
            return;
        }

        // √áift onay
        if (!confirm('Ger√ßekten t√ºm sorularƒ± silmek istiyor musunuz? Son uyarƒ±.')) {
            return;
        }

        try {
            logger.bilgi('T√ºm sorular siliniyor...');
            const data = await apiIstegi('/tum-sorulari-sil', {
                method: 'DELETE'
            });

            logger.basarili('T√ºm sorular silindi', data);
            toastGoster(data.mesaj, 'success');
            setTimeout(() => location.reload(), 1500);
        } catch (error) {
            logger.hata('Silme i≈ülemi ba≈üarƒ±sƒ±z', error);
        }
    }

    async function sayacSifirla(tablo) {
        const result = await Swal.fire({
            title: 'Deƒüerli Hocam, Emin misiniz?',
            text: "Bu i≈ülem saya√ßlarƒ± (ID) 1'e d√∂nd√ºrecektir. Eƒüer veritabanƒ±nda hala kayƒ±t varsa bu i≈ülem √ßakƒ±≈ümalara yol a√ßabilir. Verilerin silindiƒüinden emin misiniz?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Evet, Sƒ±fƒ±rla',
            cancelButtonText: 'Vazge√ß'
        });

        if (!result.isConfirmed) return;

        // The original instruction had a double confirm here, but it was for "silmek" (delete)
        // and was likely a copy-paste error from tumSorulariSil.
        // For a counter reset, a single Swal.fire confirmation is usually sufficient.
        // If a second confirmation is truly needed for 'sayacSifirla', it should be rephrased.

        try {
            logger.bilgi(`Saya√ßlar sƒ±fƒ±rlanƒ±yor: ${tablo}...`);
            const data = await apiIstegi(`/sayac-sifirla/${tablo}`, {
                method: 'POST' // Assuming a POST request for state change
            });

            if (data.basarili) {
                logger.basarili(`Saya√ß ba≈üarƒ±yla sƒ±fƒ±rlandƒ±: ${tablo}`, data);
                toastGoster(data.mesaj, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                logger.hata(`Saya√ß sƒ±fƒ±rlama ba≈üarƒ±sƒ±z: ${tablo}`, data);
                toastGoster(data.mesaj || 'Saya√ß sƒ±fƒ±rlanƒ±rken hata olu≈ütu', 'error');
            }
        } catch (error) {
            logger.hata('Saya√ß sƒ±fƒ±rlama i≈ülemi ba≈üarƒ±sƒ±z', error);
            toastGoster('Saya√ß sƒ±fƒ±rlanƒ±rken bir hata olu≈ütu', 'error');
        }
    }

    // G√∂rsel Y√ºkleme Fonksiyonu
    async function gorselYukle(input) {
        if (input.files && input.files[0]) {
            const formData = new FormData();
            formData.append('gorsel', input.files[0]);

            logger.bilgi('G√∂rsel y√ºkleniyor...');

            try {
                const response = await fetch('/gorsel-yukle', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.basarili) {
                    document.getElementById('guncelleGorselYolu').value = data.dosya_yolu;
                    onizlemeGuncelle('guncelle');
                    onizlemeGuncelle('guncelle');
                    document.getElementById('gorselPreviewImg').src = data.dosya_yolu;
                    document.getElementById('gorselPlaceholder').classList.add('hidden');
                    document.getElementById('gorselPreviewContainer').classList.remove('hidden');
                    toastGoster('G√∂rsel ba≈üarƒ±yla y√ºklendi', 'success');
                } else {
                    toastGoster(data.mesaj, 'error');
                }
            } catch (error) {
                console.error('Y√ºkleme hatasƒ±:', error);
                toastGoster('G√∂rsel y√ºklenirken hata olu≈ütu', 'error');
            }
        }
    }

    function gorselKaldir() {
        document.getElementById('guncelleGorselYolu').value = '';
        document.getElementById('guncelleGorselInput').value = '';
        document.getElementById('gorselPlaceholder').classList.remove('hidden');
        document.getElementById('gorselPreviewContainer').classList.add('hidden');
    }

    // Puan deƒüi≈üince hafƒ±zaya al
    document.getElementById('guncellePuan').addEventListener('change', (e) => {
        localStorage.setItem('sonAyarlananPuan', e.target.value);
    });

    // Soru G√ºncelleme Modal Fonksiyonlarƒ±
    async function soruDuzenle(soruId) {
        try {
            logger.bilgi('Soru bilgileri getiriliyor', { soruId });

            const response = await fetch(`/soru/${soruId}`);
            const data = await response.json();

            if (data.basarili) {
                const soru = data.soru;

                // Form alanlarƒ±nƒ± doldur
                document.getElementById('guncelleSoruId').value = soru.id;
                document.getElementById('guncellenecekSoruId').textContent = soru.id;
                document.getElementById('guncelleSoruMetni').value = soru.soru_metni || '';

                document.getElementById('guncelleSecenekA').value = soru.secenek_a || '';
                document.getElementById('guncelleSecenekB').value = soru.secenek_b || '';
                document.getElementById('guncelleSecenekC').value = soru.secenek_c || '';
                document.getElementById('guncelleSecenekD').value = soru.secenek_d || '';
                document.getElementById('guncelleSecenekE').value = soru.secenek_e || '';

                // Radyo butonu se√ßimi (Doƒüru Cevap)
                const cevap = soru.dogru_cevap || 'A';
                const radyo = document.querySelector(`input[name="dogruCevap"][value="${cevap}"]`);
                if (radyo) radyo.checked = true;

                document.getElementById('guncelleKonu').value = soru.konu || '';
                document.getElementById('guncelleZorluk').value = soru.zorluk || 'Orta';
                document.getElementById('guncellePuan').value = soru.puan || 5;

                // Yeni Alanlar
                document.getElementById('guncelleGorselKonum').value = soru.gorsel_konum || 'arada';
                document.getElementById('guncelleSikDuzeni').value = soru.sik_duzeni || 'alt_alta';

                // G√∂rsel alanƒ±
                if (soru.gorsel_yolu) {
                    document.getElementById('guncelleGorselYolu').value = soru.gorsel_yolu;
                    document.getElementById('gorselPreviewImg').src = soru.gorsel_yolu;
                    document.getElementById('gorselPlaceholder').classList.add('hidden');
                    document.getElementById('gorselPreviewContainer').classList.remove('hidden');
                } else {
                    gorselKaldir();
                }

                document.getElementById('soruGuncelleModal').classList.remove('hidden');
                onizlemeGuncelle('guncelle');
                onizlemeGuncelle('guncelle');
                setTimeout(() => lucide.createIcons(), 100);
            }
        } catch (error) {
            console.error(error);
            toastGoster('Soru bilgileri alƒ±nƒ±rken hata olu≈ütu', 'error');
        }
    }

    // Submit Handler
    document.getElementById('soruGuncelleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const orjinalMetin = submitBtn.innerHTML;
        const soruId = document.getElementById('guncelleSoruId').value;
        const secilenCevap = document.querySelector('input[name="dogruCevap"]:checked')?.value || 'A';

        const soruData = {
            soru_metni: document.getElementById('guncelleSoruMetni').value,
            secenek_a: document.getElementById('guncelleSecenekA').value,
            secenek_b: document.getElementById('guncelleSecenekB').value,
            secenek_c: document.getElementById('guncelleSecenekC').value,
            secenek_d: document.getElementById('guncelleSecenekD').value,
            secenek_e: document.getElementById('guncelleSecenekE').value,
            dogru_cevap: secilenCevap,
            konu: document.getElementById('guncelleKonu').value,
            zorluk: document.getElementById('guncelleZorluk').value,
            puan: parseInt(document.getElementById('guncellePuan').value),
            gorsel_yolu: document.getElementById('guncelleGorselYolu').value,
            gorsel_konum: document.getElementById('guncelleGorselKonum').value,
            sik_duzeni: document.getElementById('guncelleSikDuzeni').value
        };

        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'G√ºncelleniyor...';
            const response = await fetch(`/soru-guncelle/${soruId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(soruData)
            });
            const data = await response.json();
            if (data.basarili) {
                toastGoster('Soru g√ºncellendi!', 'success');
                kapatSoruGuncelleModal();
                setTimeout(() => location.reload(), 500);
            } else {
                toastGoster(data.mesaj, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = orjinalMetin;
            }
        } catch (error) {
            toastGoster('Hata olu≈ütu', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = orjinalMetin;
        }
    });

    function kapatSoruGuncelleModal() {
        document.getElementById('soruGuncelleModal').classList.add('hidden');
    }

    // --- CANLI √ñNƒ∞ZLEME LOGIC ---
    function onizlemeGuncelle(sourceType) {
        const prefix = sourceType === 'ekle' ? 'ekle' : 'guncelle';
        const onizlemeAlani = document.getElementById(prefix + 'CanliOnizleme');
        if (!onizlemeAlani) return;

        const soruMetniEl = document.getElementById(prefix + 'SoruMetni');
        const soruMetni = soruMetniEl ? soruMetniEl.value : '';
        const gorselYolu = document.getElementById(prefix + 'GorselYolu').value;
        const gorselKonum = document.getElementById(prefix + 'GorselKonum').value;
        const sikDuzeni = document.getElementById(prefix + 'SikDuzeni').value;

        if (!soruMetni && !gorselYolu) {
            onizlemeAlani.innerHTML = '<p class="text-slate-400 text-center italic">√ñnizleme i√ßin veri giriniz...</p>';
            return;
        }

        const siklar = {};
        ['A', 'B', 'C', 'D', 'E'].forEach(harf => {
            const el = document.getElementById(prefix + 'Secenek' + harf);
            if (el && el.value) siklar[harf] = el.value;
        });

        let html = '<div class="flex flex-col sm:flex-row gap-6 items-start">';
        const imgTag = gorselYolu ? `<img src="${gorselYolu}" class="max-w-full h-auto max-h-60 rounded-lg border border-slate-200 object-contain mx-auto mb-4 bg-white">` : '';
        let mainContent = `<div class="flex-1 min-w-0 w-full">`;
        if (gorselKonum === 'ustte' && imgTag) mainContent += `<div class="text-center mb-4">${imgTag}</div>`;
        mainContent += `<div class="text-[16px] text-slate-900 leading-relaxed font-medium mb-3 text-justify whitespace-pre-line">${soruMetni || 'Soru metni...'}</div>`;
        if ((gorselKonum === 'arada' || !gorselKonum) && imgTag) mainContent += `<div class="text-center my-4">${imgTag}</div>`;
        if (Object.keys(siklar).length > 0) {
            let sikClass = 'space-y-2';
            if (sikDuzeni === 'yan_yana') sikClass = 'flex flex-wrap gap-x-6 gap-y-2';
            else if (sikDuzeni === 'iki_sutun') sikClass = 'grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2';
            mainContent += `<div class="mt-4 ${sikClass} ml-1">`;
            Object.keys(siklar).forEach(harf => {
                mainContent += `<div class="flex items-start gap-2 min-w-[100px]"><span class="flex-shrink-0 w-6 h-6 rounded-full border border-slate-400 flex items-center justify-center text-xs font-bold text-slate-700 bg-white">${harf}</span><span class="text-sm text-slate-900 pt-0.5 leading-snug">${siklar[harf]}</span></div>`;
            });
            mainContent += `</div>`;
        }
        mainContent += `</div>`;
        html += mainContent;
        if (gorselKonum === 'yanda' && imgTag) html += `<div class="flex-shrink-0 w-full sm:w-1/3 ml-0 sm:ml-4 mb-4 sm:mb-0">${imgTag}</div>`;
        html += '</div>';
        onizlemeAlani.innerHTML = html;
    }

    function setupLivePreview(sourceType) {
        const prefix = sourceType === 'ekle' ? 'ekle' : 'guncelle';
        const inputs = ['SoruMetni', 'GorselKonum', 'SikDuzeni', 'SecenekA', 'SecenekB', 'SecenekC', 'SecenekD', 'SecenekE'];
        inputs.forEach(id => {
            const el = document.getElementById(prefix + id);
            if (el) {
                el.addEventListener('input', () => onizlemeGuncelle(sourceType));
                el.addEventListener('change', () => onizlemeGuncelle(sourceType));
            }
        });
    }

    setTimeout(() => {
        setupLivePreview('ekle');
        setupLivePreview('guncelle');
    }, 1000);

    // --- Fƒ∞LTRELEME MANTIƒûI ---
    function filtreleSorular() {
        const arama = document.getElementById('aramaInput').value.toLowerCase();
        const konu = document.getElementById('konuFiltre').value;
        const zorluk = document.getElementById('zorlukFiltre').value;
        const kartlar = document.querySelectorAll('.soru-kart');
        let gorunurSayisi = 0;

        kartlar.forEach(kart => {
            const metin = kart.querySelector('p').innerText.toLowerCase();
            const kartKonu = kart.getAttribute('data-konu') || "";
            const kartZorluk = kart.getAttribute('data-zorluk') || "";

            const metinUygun = metin.includes(arama);
            const konuUygun = !konu || kartKonu === konu;
            const zorlukUygun = !zorluk || kartZorluk === zorluk;

            if (metinUygun && konuUygun && zorlukUygun) {
                kart.classList.remove('hidden');
                gorunurSayisi++;
            } else {
                kart.classList.add('hidden');
            }
        });
        const sayiEl = document.querySelector('p.text-slate-600');
        if (sayiEl) sayiEl.innerText = `${gorunurSayisi} soru listeleniyor`;
    }

    document.getElementById('aramaInput')?.addEventListener('input', filtreleSorular);
    document.getElementById('konuFiltre')?.addEventListener('change', filtreleSorular);
    document.getElementById('zorlukFiltre')?.addEventListener('change', filtreleSorular);

    function filtreleriTemizle() {
        const aramaInput = document.getElementById('aramaInput');
        const konuFiltre = document.getElementById('konuFiltre');
        const zorlukFiltre = document.getElementById('zorlukFiltre');

        if (aramaInput) aramaInput.value = '';
        if (konuFiltre) konuFiltre.selectedIndex = 0;
        if (zorlukFiltre) zorlukFiltre.selectedIndex = 0;

        filtreleSorular();
    }
</script>


{% endblock %}
```