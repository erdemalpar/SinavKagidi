{% extends "base.html" %}

{% block title %}Sınav Önizleme - {{ sinav.baslik }}{% endblock %}

{% block extra_styles %}
<style>
    @media print {
        @page {
            margin: 0;
            size: A4;
        }

        body {
            background: white;
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
        }

        /* Tüm gereksiz elementleri gizle */
        nav,
        aside,
        footer,
        .no-print,
        #sidebar,
        #menuToggle {
            display: none !important;
        }

        /* Ana içeriği sıfırla */
        main {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            max-width: none !important;
        }

        /* Sınav Kağıdı Ayarları */
        .sinav-kagidi {
            box-shadow: none !important;
            margin: 0 !important;
            width: 100% !important;
            max-width: 210mm !important;
            /* A4 Genişliği */
        }

        .a4-sayfa {
            padding: 0 2cm 0 2cm !important;
            /* Yalnızca yan boşluklar sabit */
            width: 100% !important;
            margin: 0 !important;
            min-height: auto !important;
            box-shadow: none !important;
        }

        /* Sayfa sonu ayarları */
        .soru-blok {
            break-inside: avoid;
            /* Soruyu bölme */
            page-break-inside: avoid;
        }

        .sayfa-basi {
            margin-top: 10px !important;
        }
    }

    /* Görsel Seçimi */
    .img-selected {
        outline: 3px solid #3b82f6 !important;
        cursor: grab;
        opacity: 1;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
    }

    .resizable-img {
        cursor: pointer;
        transition: outline 0.1s, box-shadow 0.1s;
    }

    .resizable-img:hover {
        outline: 2px dashed #cbd5e1;
    }

    /* Manuel Sayfa Sonu */
    .sayfa-basi {
        break-before: page !important;
        page-break-before: always !important;
        padding-top: 0 !important;
        border-top: none !important;
    }


    /* Ekran Görüntüsü Ayarları */
    .sayfa-basi-gosterge {
        display: none;
    }

    .sayfa-basi .sayfa-basi-gosterge {
        display: flex;
    }

    .sayfa-basi {
        margin-top: 2rem;
    }

    .sinav-kagidi {
        background: white;
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        width: 210mm;
        margin: 0 auto;
        min-height: 297mm;
        /* Tam bir A4 uzunluğu */
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        /* Padding'ler boyutu büyütmez */
        overflow: hidden;
        /* Dışarı taşmaları engeller */
    }

    .a4-sayfa {
        padding: 0 2cm 0 2cm;
        display: flex;
        flex-direction: column;
        flex: 1;
        /* Kalan tüm A4 yüksekliğini kaplar */
        position: relative;
        box-sizing: border-box;
    }

    /* İmza Alanı Düzenlemeleri */
    .ekstra-imza {
        display: block !important;
        margin-top: 2rem !important;
        padding-top: 0.75rem !important;
        border-top: 2px solid #0f172a !important;
        /* Koyu lacivert/siyah çizgi */
        text-align: center !important;
        width: 100% !important;
        page-break-after: always !important;
        /* Kendisinden sonrasını yeni sayfaya atar */
        break-after: page !important;
        page-break-inside: avoid !important;
        clear: both !important;
    }

    .ekstra-imza p {
        margin: 0 !important;
        font-weight: bold !important;
        color: #0f172a !important;
        font-size: 11pt !important;
    }

    /* Sayfa başı olan eleman için ek kurallar */
    .sayfa-basi {

        /* Slider değeri hem önizlemede itmeyi sağlar hem PDF'de boşluk bırakır */
        margin-top: {
                {
                sinav.sayfa2_ust_bosluk|default(40)
            }
        }

        px !important;
        position: relative;
        break-before: page;
        page-break-before: always;
    }

    /* Önizlemede sayfa bölünme çizgi ayracı */
    .sayfa-basi::before {
        content: "";
        position: absolute;
        top: -2.5rem;
        left: -2cm;
        right: -2cm;
        border-top: 2px dashed #6366f1;
        opacity: 0.3;
        pointer-events: none;
    }

    /* Sayfa Silme Butonu Stili */
    .sayfa-sil-btn {
        position: absolute;
        top: -3.5rem;
        right: -1rem;
        background: #ef4444;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        z-index: 60;
        transition: all 0.2s;
        border: none;
    }

    .sayfa-sil-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .sayfa-basi-label {
        position: absolute;
        top: -3.5rem;
        left: 50%;
        transform: translateX(-50%);
        background: #6366f1;
        color: white;
        font-size: 9px;
        font-weight: 800;
        padding: 4px 12px;
        border-radius: 9999px;
        letter-spacing: 2px;
        z-index: 55;
        text-transform: uppercase;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }

    @media print {
        .sayfa-basi::before {
            display: none;
        }
    }

    /* Mouse ile konumlandırma ve boşluk ayarı */
    .spacer-handle {
        height: 12px;
        width: 100%;
        cursor: row-resize;
        position: absolute;
        top: -6px;
        left: 0;
        right: 0;
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s, background 0.2s;
        border-radius: 4px;
        user-select: none;
    }

    .soru-blok:hover .spacer-handle {
        opacity: 1;
        background: rgba(99, 102, 241, 0.05);
        /* Çok hafif arka plan */
    }

    .spacer-handle:active,
    .spacer-handle.dragging {
        opacity: 1;
        background: rgba(99, 102, 241, 0.2);
    }

    .spacer-handle::after {
        content: "";
        width: 100px;
        height: 4px;
        background: #6366f1;
        border-radius: 2px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .soru-blok {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: default;
    }

    /* Sortable Dragging Styles */
    .sortable-ghost {
        opacity: 0.3;
        background: #e2e8f0 !important;
        border: 2px dashed #6366f1 !important;
    }

    .sortable-drag {
        opacity: 0.9;
        cursor: grabbing !important;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        transform: scale(1.02);
        background: white;
    }

    .drag-handle:active {
        cursor: grabbing;
    }

    /* Sayfa Bölme Modu Stilleri */
    body.sayfa-bolme-modunda {
        cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%236366f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><line x1="20" y1="4" x2="8.12" y2="15.88"></line><line x1="14.47" y1="14.48" x2="20" y2="20"></line><line x1="8.12" y1="8.12" x2="12" y2="12"></line></svg>'), auto !important;
    }

    body.sayfa-bolme-modunda .soru-blok {
        cursor: pointer !important;
        position: relative;
    }

    body.sayfa-bolme-modunda .soru-blok:hover {
        background: rgba(99, 102, 241, 0.1) !important;
        outline: 2px dashed #6366f1 !important;
    }

    body.sayfa-bolme-modunda .soru-blok:hover::after {
        content: "Buradan Yeni Sayfa Başlat";
        position: absolute;
        top: -24px;
        left: 50%;
        transform: translateX(-50%);
        background: #6366f1;
        color: white;
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 4px;
        z-index: 100;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col xl:flex-row gap-6 p-4 relative items-start min-h-screen pb-20">

    <!-- Sağ Panel (Ayarlar Sidebar) -->
    <aside class="w-full xl:w-80 shrink-0 order-1 xl:order-2 space-y-4 no-print xl:sticky xl:top-4 z-40">

        <!-- Kart 1: Başlık ve İşlemler -->
        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
            <div class="flex items-center justify-between mb-4 pb-3 border-b border-slate-100">
                <h2 class="font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="settings-2" class="w-4 h-4 text-slate-500"></i>
                    <span>Ayarlar</span>
                </h2>
                <a href="{{ url_for('sinav_hazirlama', sinav=sinav.id) }}"
                    class="text-xs font-medium text-slate-500 hover:text-red-600 bg-slate-50 hover:bg-red-50 px-2.5 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                    <i data-lucide="arrow-left" class="w-3 h-3"></i>
                    Geri
                </a>
            </div>

            <div class="mb-4 bg-slate-50 rounded-lg p-3 border border-slate-100">
                <h3 class="font-bold text-sm text-slate-900 line-clamp-2 leading-snug">{{ sinav.baslik }}</h3>
                <div
                    class="flex items-center gap-2 mt-2 text-[10px] font-medium text-slate-500 uppercase tracking-wider">
                    <span>{{ sinav.sorular|length }} SORU</span>
                    <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                    <span>{{ sinav.sorular|sum(attribute='soru.puan') }} PUAN</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2 mb-2">
                <button onclick="window.print()"
                    class="flex items-center justify-center gap-2 px-3 py-2 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:text-slate-900 rounded-lg transition-all text-xs font-bold shadow-sm">
                    <i data-lucide="printer" class="w-4 h-4"></i>
                    YAZDIR
                </button>
                <button onclick="pdfOlustur()"
                    class="flex items-center justify-center gap-2 px-3 py-2 bg-slate-900 text-white hover:bg-slate-800 rounded-lg transition-all text-xs font-bold shadow-md shadow-slate-900/20">
                    <i data-lucide="file-down" class="w-4 h-4"></i>
                    PDF
                </button>
            </div>
            <button id="siralaBtn" onclick="soruSiralamayiAc()"
                class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-indigo-50 border border-indigo-100 text-indigo-700 hover:bg-indigo-100 rounded-lg transition-all text-xs font-bold mt-2 shadow-sm">
                <i data-lucide="list-ordered" class="w-4 h-4"></i>
                <span>Soru Sıralamasını Değiştir</span>
            </button>

            <button id="sayfaBolmeBtn" onclick="toggleSayfaBolmeModu()"
                class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-slate-200 text-slate-600 hover:bg-indigo-50 hover:border-indigo-200 hover:text-indigo-700 rounded-lg transition-all text-xs font-bold mt-2">
                <i data-lucide="scissors" class="w-4 h-4 text-indigo-500"></i>
                <span>Sayfa Bölme Modu</span>
            </button>

            <button id="sinirBtn" onclick="sayfaSinirlariniGoster(this)"
                class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 rounded-lg transition-all text-xs font-medium mt-2">
                <i data-lucide="scan-line" class="w-3.5 h-3.5"></i>
                <span>Sayfa Sınırlarını Göster</span>
            </button>
        </div>

        <!-- DIVINE: Görünüm Ayarları Paneli -->
        <div id="ayarlar-panel-konteynir" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm space-y-6">
            <div class="flex items-center gap-2 mb-2 pb-2 border-b border-slate-50">
                <i data-lucide="layout-template" class="w-4 h-4 text-indigo-500"></i>
                <h3 class="font-bold text-xs uppercase tracking-widest text-slate-800">Görünüm Ayarları</h3>
            </div>

            <!-- Görsel -->
            <div class="space-y-3">
                <div class="flex items-center justify-between text-xs font-medium text-slate-700">
                    <div class="flex items-center gap-1.5">
                        <i data-lucide="image" class="w-3.5 h-3.5 text-slate-400"></i>
                        <span>Görsel Boyutu</span>
                    </div>
                </div>
                <div class="relative group">
                    <input type="range" id="gorselBoyutSlider" min="0" max="150" value="50" disabled
                        oninput="gorselBoyutuDegistir(this.value)"
                        class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600 disabled:opacity-40">
                    <div
                        class="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                        Görsele tıklayarak aktif edin
                    </div>
                </div>
            </div>

            <!-- Başlık -->
            <div class="space-y-3 pt-4 border-t border-slate-100">
                <div class="flex items-center justify-between text-xs font-medium text-slate-700">
                    <div class="flex items-center gap-1.5">
                        <i data-lucide="heading" class="w-3.5 h-3.5 text-slate-400"></i>
                        <span>Başlık Boyutu</span>
                    </div>
                    <span id="baslikBoyutuLabel"
                        class="font-mono text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-600">
                        %{{ sinav.baslik_katsayisi|default(100) }}
                    </span>
                </div>
                <input type="range" id="baslikBoyutuSlider" min="50" max="150" step="5"
                    value="{{ sinav.baslik_katsayisi|default(100) }}" oninput="baslikBoyutuDegistir(this.value)"
                    class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
            </div>

            <!-- Şıklar -->
            <div class="space-y-4 pt-4 border-t border-slate-100">
                <h4 class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Şık Düzeni</h4>

                <!-- Şık Dikey -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-xs text-slate-600">
                        <span>Dikey Boşluk</span>
                        <span id="sikBosluguLabel" class="font-mono text-[10px]">{{ sinav.sik_boslugu|default(16)
                            }}px</span>
                    </div>
                    <input type="range" id="sikBosluguSlider" min="-14" max="50" step="-10"
                        value="{{ sinav.sik_boslugu|default(16) }}" oninput="sikBosluguDegistir(this.value)"
                        class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-500">
                </div>

                <!-- Şık İçi -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-xs text-slate-600">
                        <span>Satır Aralığı</span>
                        <span id="siklarArasiLabel" class="font-mono text-[10px]">{{
                            sinav.siklar_arasi_bosluk|default(8) }}px</span>
                    </div>
                    <input type="range" id="siklarArasiSlider" min="-10" max="30" step="1"
                        value="{{ sinav.siklar_arasi_bosluk|default(8) }}" oninput="siklarArasiDegistir(this.value)"
                        class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-500">
                </div>

                <!-- Şık Yatay -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-xs text-slate-600">
                        <span>Yatay Boşluk (Yan Yana)</span>
                        <span id="siklarYatayLabel" class="font-mono text-[10px]">{{
                            sinav.siklar_yatay_bosluk|default(24) }}px</span>
                    </div>
                    <input type="range" id="siklarYataySlider" min="-10" max="100" step="4"
                        value="{{ sinav.siklar_yatay_bosluk|default(24) }}" oninput="siklarYatayDegistir(this.value)"
                        class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-slate-500">
                </div>
            </div>

            <!-- Sayfa Düzeni -->
            <div class="space-y-4 pt-4 border-t border-slate-100">
                <h4 class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Sayfa Düzeni</h4>

                <!-- Soru Arası -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-xs text-slate-600">
                        <span>Soru Arası</span>
                        <span id="soruBoslukLabel" class="font-mono text-[10px]">50px</span>
                    </div>
                    <input type="range" id="soruBoslukSlider" min="0" max="200" value="50"
                        oninput="soruBoslukDegistir(this.value)"
                        class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600">
                </div>

                <!-- Üst Kenar -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-xs text-slate-600">
                        <span>Üst Kenar</span>
                        <span id="ustBoslukLabel" class="font-mono text-[10px]">{{ sinav.ust_bosluk|default(40)
                            }}px</span>
                    </div>
                    <input type="range" id="ustBoslukSlider" min="0" max="200" step="5"
                        value="{{ sinav.ust_bosluk|default(40) }}" oninput="ustBoslukDegistir(this.value)"
                        class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600">
                </div>

                <!-- İmza Alt Boşluk -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-xs text-slate-600">
                        <span>Alt Boşluk (İmza)</span>
                        <span id="imzaAltBoslukLabel" class="font-mono text-[10px]">{{ sinav.imza_alt_bosluk|default(40)
                            }}px</span>
                    </div>
                    <input type="range" id="imzaAltBoslukSlider" min="0" max="300" step="5"
                        value="{{ sinav.imza_alt_bosluk|default(40) }}" oninput="imzaAltBoslukDegistir(this.value)"
                        class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600">
                </div>

                <!-- Diğer Sayfalar Üst Padding -->
                <div id="odakli-padding-kontrol"
                    class="space-y-2 p-3 rounded-lg border-2 border-transparent transition-all">
                    <div class="flex items-center justify-between text-xs text-slate-600">
                        <span id="padding-kontrol-baslik" class="font-bold">Genel Sayfa Üst Boşluğu</span>
                        <span id="sayfa2UstBoslukLabel" class="font-mono text-[10px]">{{
                            sinav.sayfa2_ust_bosluk|default(40)
                            }}px</span>
                    </div>
                    <input type="range" id="sayfa2UstBoslukSlider" min="0" max="400" step="5"
                        value="{{ sinav.sayfa2_ust_bosluk|default(40) }}" oninput="odakliPaddingGuncelle(this.value)"
                        class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                    <p id="padding-kontrol-yardim" class="text-[9px] text-slate-400">Genel veya seçili sayfanın
                        boşluğunu ayarlar.</p>
                </div>
            </div>

        </div>
    </aside>

    <!-- Ana İçerik (Sınav Kağıdı) -->
    <div class="flex-1 order-2 xl:order-1 w-full flex justify-center min-w-0">
        <div id="sinavKagidi" style="font-family: {{ sinav.yazi_fontu or " inherit" }}; font-size: {{ sinav.yazi_boyutu
            or 12 }}px; color: {{ sinav.yazi_rengi or "#000000" }}; font-weight: {{ sinav.yazi_stili or "normal" }};
            padding-top: {{ sinav.ust_bosluk|default(40) }}px;" class="sinav-kagidi">
            <div class="a4-sayfa">

                <!-- Antet (Logo, Başlık vs.) -->
                <header class="border-b-4 border-slate-900 pb-6 mb-8">
                    <div class="flex items-center justify-between gap-4">
                        <!-- Sol Logo -->
                        <div class="w-[150px] flex-shrink-0 text-left flex justify-start">
                            {% if sinav.logo_sol %}
                            <img src="{{ sinav.logo_sol }}" alt="" class="resizable-img" data-type="height"
                                style="height: {{ sinav.logo_boyutu }}px; width: auto; max-width: 100%; object-fit: contain;">
                            {% endif %}
                        </div>

                        <!-- Orta Metin -->
                        <div class="flex-1 text-center">
                            <h1 class="baslik-metin text-2xl font-black text-slate-900 tracking-tight mb-2 uppercase leading-tight"
                                data-base-size="{{ sinav.okul_adi_boyutu or 24 }}"
                                style="font-size: {{ (sinav.okul_adi_boyutu or 24) * (sinav.baslik_katsayisi|default(100))/100 }}px;">
                                {{
                                sinav.okul_adi or (ayarlar.okul_adi if ayarlar else 'OKUL ADI') }}</h1>

                            <h2 class="baslik-metin text-lg font-bold text-slate-700 mb-0.5 leading-snug uppercase"
                                data-base-size="{{ sinav.egitim_yili_boyutu or 18 }}"
                                style="font-size: {{ (sinav.egitim_yili_boyutu or 18) * (sinav.baslik_katsayisi|default(100))/100 }}px;">
                                {{ sinav.egitim_yili or (ayarlar.egitim_yili if ayarlar else '') }} Eğitim Öğretim Yılı
                            </h2>

                            <h3 class="baslik-metin text-base font-bold text-slate-700 mb-0.5 leading-snug uppercase"
                                data-base-size="{{ sinav.donem_boyutu or 16 }}"
                                style="font-size: {{ (sinav.donem_boyutu or 16) * (sinav.baslik_katsayisi|default(100))/100 }}px;">
                                {{ sinav.donem or (ayarlar.donem if ayarlar else '') }}
                            </h3>

                            {% if sinav.baslik %}
                            <h4 class="baslik-metin text-base font-bold text-slate-700 leading-snug"
                                data-base-size="{{ sinav.baslik_boyutu or 16 }}"
                                style="font-size: {{ (sinav.baslik_boyutu or 16) * (sinav.baslik_katsayisi|default(100))/100 }}px;">
                                {{ sinav.baslik }}
                            </h4>
                            {% endif %}
                        </div>

                        <!-- Sağ Logo -->
                        <div class="w-[150px] flex-shrink-0 text-right flex justify-end">
                            {% if sinav.logo_sag %}
                            <img src="{{ sinav.logo_sag }}" alt="" class="resizable-img" data-type="height"
                                style="height: {{ sinav.logo_boyutu }}px; width: auto; max-width: 100%; object-fit: contain;">
                            {% endif %}
                        </div>
                    </div>

                    <!-- Öğrenci Bilgi Alanı -->
                    <div class="baslik-metin mt-8 grid grid-cols-2 gap-x-12 gap-y-4 text-left font-medium"
                        data-base-size="14" style="font-size: {{ 14 * (sinav.baslik_katsayisi|default(100))/100 }}px;">
                        <div class="flex items-end gap-2">
                            <span class="font-bold text-slate-900 min-w-[80px]">Adı Soyadı:</span>
                            <div class="flex-1 border-b border-black border-dotted h-4"></div>
                        </div>

                        <div class="flex items-end gap-2">
                            <span class="font-bold text-slate-900 min-w-[60px]">Tarih:</span>
                            <span class="flex-1 border-b border-black border-dotted h-4 pb-0.5 pl-2 font-normal">{{
                                sinav.tarih|turkce_tarih or (ayarlar.tarih|turkce_tarih if ayarlar and ayarlar.tarih
                                else '') }}
                                {% if sinav.saat %} / {{ sinav.saat }}{% endif %}
                            </span>
                        </div>
                    </div>
                </header>

                <!-- Sorular -->
                <div class="space-y-8" id="sorularContainer">
                    {% for sinav_sorusu in sinav.sorular %}
                    {% set soru = sinav_sorusu.soru %}

                    <div class="soru-blok relative group border-2 border-transparent hover:border-indigo-100 rounded-xl transition-all p-2 -m-2"
                        data-soru-id="{{ sinav_sorusu.soru_id }}"
                        style="margin-top: {{ sinav_sorusu.ust_bosluk|default(0) }}px;">

                        <!-- Mouse ile Boşluk Ayarı Tutamacı (Resize) -->
                        <div class="spacer-handle no-print" onmousedown="startSpacerDrag(event, this)"></div>

                        <!-- Doğrudan Sürükle-Bırak Tutamacı -->
                        <div class="absolute -left-8 top-1/2 -translate-y-1/2 hidden group-hover:flex items-center justify-center p-2 bg-white shadow-sm border border-slate-200 rounded-lg cursor-grab active:cursor-grabbing no-print drag-handle"
                            title="Soruyu Taşı">
                            <i data-lucide="grip-vertical" class="w-4 h-4 text-slate-400"></i>
                        </div>

                        <!-- Manuel Sayfa Sonu Kontrolü (Tamamen sola, tıklama çakışması engellendi) -->
                        <div class="absolute -top-12 -left-28 hidden group-hover:flex z-[100] no-print">
                            <button onclick="sayfaSonuToggle(this)" onmousedown="event.stopPropagation()"
                                class="no-drag bg-indigo-600 text-white text-[9px] px-2.5 py-1.5 rounded-lg shadow-lg hover:bg-indigo-700 transition cursor-pointer flex items-center gap-1 font-bold uppercase tracking-wider border border-white/20 whitespace-nowrap">
                                <i data-lucide="scissors" class="w-3 h-3"></i>
                                Yeni Sayfa Başlat
                            </button>
                        </div>

                        <!-- Sayfa Silme İkonu (Burada her zaman erişilebilir yaptık) -->
                        <button onclick="sayfaSil(this)"
                            class="sayfa-sil-onay-btn absolute -top-4 -right-4 bg-red-500 text-white p-2 rounded-full shadow-lg hover:bg-red-600 transition-all z-50 no-print flex items-center justify-center {{ 'hidden' if not 'sayfa-basi' in sinav_sorusu.ust_bosluk_stili else '' }}">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>


                        <div class="flex items-start gap-4" onclick="soruOdakla(this.parentElement)">
                            <!-- Soru Numarası -->
                            <div class="flex-shrink-0 pt-1">
                                <span
                                    class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-900 text-white font-bold text-sm shadow-sm print:bg-black print:text-white">
                                    {{ loop.index }}
                                </span>
                            </div>

                            <div class="flex-1 min-w-0">
                                <!-- ÜST GÖRSEL -->
                                {% if soru.gorsel_yolu and soru.gorsel_konum == 'ustte' %}
                                <div class="mb-4 text-center">
                                    <img src="{{ soru.gorsel_yolu }}"
                                        style="max-height: 240px; width: {{ sinav.gorsel_boyutu }}%; object-fit: contain;"
                                        alt="Soru görseli"
                                        class="resizable-img max-w-full h-auto max-h-60 rounded-lg border border-slate-200 object-contain mx-auto print:border-none"
                                        data-type="width">
                                </div>
                                {% endif %}

                                <div
                                    class="flex flex-col sm:flex-row gap-6 {{ 'items-start' if soru.gorsel_konum == 'yanda' and soru.sik_duzeni == 'iki_sutun' else '' }}">
                                    <div class="flex-1">
                                        <!-- Soru Metni -->
                                        <div
                                            class="soru-metni text-inherit text-slate-900 leading-relaxed font-medium mb-3 text-justify whitespace-pre-line">
                                            {{ soru.soru_metni }}</div>

                                        <!-- ARA GÖRSEL -->
                                        {% if soru.gorsel_yolu and (soru.gorsel_konum == 'arada' or not
                                        soru.gorsel_konum or
                                        (soru.gorsel_konum == 'yanda' and soru.sik_duzeni != 'iki_sutun'))
                                        %}
                                        <div class="my-4 text-center">
                                            <img src="{{ soru.gorsel_yolu }}"
                                                style="max-height: 240px; width: {{ sinav.gorsel_boyutu }}%; object-fit: contain;"
                                                alt="Soru görseli"
                                                class="resizable-img max-w-full h-auto max-h-60 rounded-lg border border-slate-200 object-contain mx-auto print:border-none"
                                                data-type="width">
                                        </div>
                                        {% endif %}

                                        <!-- Şıklar -->
                                        {% if (soru.soru_tipi == 'test' or not soru.soru_tipi) and (soru.secenek_a or
                                        soru.secenek_b or soru.secenek_c or soru.secenek_d or
                                        soru.secenek_e) %}

                                        <!-- Şık Düzeni Sınıfları -->
                                        {% set sik_class = 'flex flex-col gap-y-2' %} {# Varsayılan: Alt alta (Flex Gap)
                                        #}
                                        {% if soru.sik_duzeni == 'yan_yana' %}
                                        {% set sik_class = 'flex flex-wrap gap-x-6 gap-y-2' %}
                                        {% elif soru.sik_duzeni == 'iki_sutun' %}
                                        {% set sik_class = 'grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2' %}
                                        {% endif %}

                                        <div class="siklar-container {{ sik_class }} ml-1"
                                            style="margin-top: {{ sinav.sik_boslugu|default(16) }}px; row-gap: {{ sinav.siklar_arasi_bosluk|default(8) }}px; column-gap: {{ sinav.siklar_yatay_bosluk|default(24) }}px;">
                                            {% for sik_harfi in ['A', 'B', 'C', 'D', 'E'] %}
                                            {% set sik_attr = 'secenek_' + sik_harfi|lower %}
                                            {% if soru[sik_attr] %}
                                            <div class="sik-satir flex items-start gap-2 min-w-[100px] group/sik">
                                                <span
                                                    class="flex-shrink-0 rounded-full border border-slate-400 flex items-center justify-center font-bold print:border-black group-hover/sik:border-slate-600 transition-colors"
                                                    style="width: 1.6em; height: 1.6em; font-size: 0.75em;">{{
                                                    sik_harfi }}</span>
                                                <span class="text-inherit text-slate-900 pt-0.5 leading-snug">{{
                                                    soru[sik_attr]
                                                    }}</span>
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                        {% endif %}

                                        <!-- ALT GÖRSEL (Şıkların Altında) -->
                                        {% if soru.gorsel_yolu and soru.gorsel_konum == 'altta' %}
                                        <div class="my-4 text-center">
                                            <img src="{{ soru.gorsel_yolu }}"
                                                style="max-height: 240px; width: {{ sinav.gorsel_boyutu }}%; object-fit: contain;"
                                                alt="Soru görseli"
                                                class="resizable-img max-w-full h-auto max-h-60 rounded-lg border border-slate-200 object-contain mx-auto print:border-none"
                                                data-type="width">
                                        </div>
                                        {% endif %}

                                        {# Yazdırma için Puan (Sorunun sonunda) #}
                                        {% if ayarlar.puan_goster %}
                                        <div class="hidden print:block text-right mt-2 font-bold"
                                            style="font-size: {{ (sinav.puan_kutusu_boyutu|default(100))/100 }}em;">
                                            ({{ soru.puan }} Puan)
                                        </div>
                                        {% endif %}
                                    </div>

                                    <!-- YAN GÖRSEL -->
                                    {% if soru.gorsel_yolu and soru.gorsel_konum == 'yanda' and soru.sik_duzeni ==
                                    'iki_sutun' %}
                                    <div class="flex-shrink-0 w-full sm:w-1/3 ml-0 mb-4 sm:mb-0">
                                        <img src="{{ soru.gorsel_yolu }}"
                                            style="max-height: 240px; width: {{ sinav.gorsel_boyutu }}%; object-fit: contain;"
                                            alt="Soru görseli"
                                            class="resizable-img w-full h-auto rounded-lg border border-slate-200 object-contain print:border-none bg-slate-50"
                                            data-type="width">
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Puan (Sağda Sabit) -->
                            <!-- Puan (Sağda Sabit) -->
                            {% if ayarlar.puan_goster %}
                            <div class="flex-shrink-0 ml-2 pt-1 no-print"
                                style="transform: scale({{ (sinav.puan_kutusu_boyutu|default(100))/100 }}); transform-origin: top right;">
                                <div class="text-center border border-slate-300 rounded px-2 py-0.5 bg-slate-50">
                                    <div class="text-[10px] text-slate-400 font-bold uppercase">Puan</div>
                                    <div class="text-base font-bold text-slate-700 leading-none">{{ soru.puan }}</div>
                                </div>
                            </div>
                            {# Yazdırma için puan gösterimi (Genelde istenmez ama opsiyonel) #}
                            {# Yazdırma için puan gösterimi: İçeriğe taşındı #}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Sayfa Altı (İmza vb.) -->
                {% if ayarlar_imza %}

                <div id="anaImzaAlani" class="mt-auto pt-8 border-t-2 border-slate-900 page-break-avoid flex-shrink-0"
                    style="margin-bottom: {{ sinav.imza_alt_bosluk|default(40) }}px;">
                    <div class="text-center">
                        <p class="font-bold text-slate-900">{{ sinav.imza_metni or ayarlar_imza.imza_metni }}</p>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <script>
            function pdfOlustur() {
                const element = document.getElementById('sinavKagidi');
                const opt = {
                    margin: 0,
                    filename: '{{ sinav.baslik }}.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                toastGoster('PDF oluşturuluyor...', 'info');
                html2pdf().set(opt).from(element).save().then(() => {
                    toastGoster('PDF indirildi!', 'success');
                });
            }

            function sayfaSonuToggle(btn) {
                const soruBlok = btn.closest('.soru-blok');
                soruBlok.classList.toggle('sayfa-basi');

                const isPageBreak = soruBlok.classList.contains('sayfa-basi');

                if (isPageBreak) {
                    btn.classList.add('bg-red-600');
                    btn.classList.remove('bg-slate-800');
                    btn.innerHTML = '<i data-lucide="x" class="w-3 h-3"></i> Sayfa Sonunu Kaldır';
                } else {
                    btn.classList.remove('bg-red-600');
                    btn.classList.add('bg-slate-800');
                    btn.innerHTML = '<i data-lucide="scissors" class="w-3 h-3"></i> Yeni Sayfadan Başlat';
                }
                lucide.createIcons();
            }

            // --- Soru Sıralama Fonksiyonları ---
            let sortableInstance;

            function soruSiralamayiAc() {
                const modal = document.getElementById('siralaModal');
                if (!modal) return;
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                if (!sortableInstance) {
                    const el = document.getElementById('siralanabilirListe');
                    sortableInstance = Sortable.create(el, {
                        animation: 150,
                        ghostClass: 'bg-indigo-50',
                        onEnd: function () {
                            const itemler = el.querySelectorAll('.sira-no');
                            itemler.forEach((item, index) => {
                                item.innerText = index + 1;
                            });
                        }
                    });
                }
                lucide.createIcons();
            }

            function soruSiralamayiKapat() {
                const modal = document.getElementById('siralaModal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            }

            async function siralamayiKaydet() {
                const el = document.getElementById('siralanabilirListe');
                const itemler = el.children;
                const siralamas = [];

                for (let i = 0; i < itemler.length; i++) {
                    siralamas.push({
                        soru_id: parseInt(itemler[i].getAttribute('data-soru-id')),
                        sira: i + 1
                    });
                }

                try {
                    toastGoster('Sıralama güncelleniyor...', 'info');
                    const response = await fetch('/sinav-soru-sirala/{{ sinav.id }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ siralamas: siralamas })
                    });

                    const data = await response.json();
                    if (data.basarili) {
                        toastGoster('Sıralama başarıyla kaydedildi!', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        toastGoster('Hata: ' + data.mesaj, 'error');
                    }
                } catch (err) {
                    console.error('Sıralama hatası:', err);
                    toastGoster('Sistem hatası!', 'error');
                }
            }

            let selectedImage = null;

            // Sayfa yüklendiğinde resizable görselleri ayarla
            document.addEventListener('DOMContentLoaded', () => {
                setupResizableImages();
            });

            // Boşluğa tıklayınca seçimi kaldır
            document.addEventListener('click', (e) => {
                // Toolbar'a veya görsele tıklanmadıysa seçimi kaldır
                if (!e.target.classList.contains('resizable-img') &&
                    !e.target.closest('.group') && // Slider container
                    !e.target.closest('input[type="range"]')) {
                    deselectImage();
                }
            });

            function setupResizableImages() {
                document.querySelectorAll('.resizable-img').forEach(img => {
                    img.onclick = (e) => {
                        e.stopPropagation(); // Tıklama olayının yukarı çıkmasını engelle
                        selectImage(img);
                    };
                });
            }

            function selectImage(img) {
                if (selectedImage) {
                    selectedImage.classList.remove('img-selected');
                }
                selectedImage = img;
                selectedImage.classList.add('img-selected');

                // Büyütme kısıtlamalarını kaldır (max-width/max-height engellerini aşmak için)
                selectedImage.style.maxWidth = 'none';
                selectedImage.style.maxHeight = 'none';

                // Slider'ı güncelle ve aktif et
                const slider = document.getElementById('gorselBoyutSlider');
                const label = document.getElementById('gorselBoyutLabel');
                const type = img.dataset.type;

                slider.disabled = false;

                if (type === 'height') { // Logo (px)
                    // Mevcut yüksekliği px olarak al (style öncelikli)
                    let currentHeight = 80;
                    if (img.style.height) {
                        currentHeight = parseInt(img.style.height);
                    } else if (img.height) {
                        currentHeight = img.height;
                    }

                    slider.min = 20;
                    slider.max = 300;
                    slider.value = currentHeight;
                    label.innerText = currentHeight + 'px';
                } else { // Soru Görseli (%)
                    // Mevcut genişliği % olarak al
                    let currentWidth = 100; // Varsayılan
                    if (img.style.width && img.style.width.includes('%')) {
                        currentWidth = parseInt(img.style.width);
                    }

                    slider.min = 10;
                    slider.max = 150;
                    slider.value = currentWidth;
                    label.innerText = currentWidth + '%';
                }
            }

            function deselectImage() {
                if (selectedImage) {
                    selectedImage.classList.remove('img-selected');
                    selectedImage = null;
                }

                // Slider'ı pasif yap
                const slider = document.getElementById('gorselBoyutSlider');
                const label = document.getElementById('gorselBoyutLabel');

                slider.disabled = true;
                label.innerText = '-';
                slider.value = 50; // Ortaya çek
            }

            function gorselBoyutuDegistir(val) {
                if (!selectedImage) {
                    return;
                }

                const type = selectedImage.dataset.type;
                const label = document.getElementById('gorselBoyutLabel');

                if (type === 'height') {
                    selectedImage.style.height = val + 'px';
                    label.innerText = val + 'px';
                } else {
                    selectedImage.style.width = val + '%';
                    label.innerText = val + '%';
                }
            }

            function dikeyBoslukDegistir(val) {
                // Soru metni ile şıklar arasındaki boşluğu ayarla
                // Varsayılan (50 için) yaklaşık 12px (0.75rem)
                // Aralığı 0px ile 50px arasına yayalım. 50 -> 25px olsun.
                const metinMargin = val * 0.8;

                document.querySelectorAll('.soru-metni').forEach(el => {
                    el.style.marginBottom = metinMargin + 'px';
                });

                // Şıklar arasındaki boşluğu ayarla
                // Şıklar flex veya grid olabilir, gap veya margin ile kontrol edilebilir
                // .siklar-container gap-y-2 (0.5rem = 8px) kullanıyor. 
                // Bunu inline style ile override edelim.

                /* 
                   Not: Tailwind gap sınıflarını style="gap: ...px" ile ezebiliriz 
                   ancak grid/flex yapısına dikkat etmeliyiz.
                */
                const gap = val * 0.4; // 0px - 40px arası
                document.querySelectorAll('.siklar-container').forEach(el => {
                    // gap-y ve gap-x var, biz sadece dikey boşluğu (row-gap) etkilemek istiyoruz
                    // style.rowGap grid ve flex-wrap için çalışır
                    el.style.rowGap = gap + 'px';

                    // Eğer flex-col kullanıyorsa (yan_yana olmayanlar) space-y-2 kullanıyor olabilir
                    // space-y-2 margin-top ekler.
                    // Bunu JS ile kontrol etmek zor olabilir, bu yüzden space-y-2 classını kaldırıp
                    // yerine flex flex-col gap-y-X yapısına çevirmek daha temiz olurdu ama
                    // HTML'i değiştirmeden children'lara margin verebiliriz.
                    const children = el.children;
                    for (let i = 1; i < children.length; i++) {
                        children[i].style.marginTop = gap + 'px';
                    }
                    // space-y-2'nin css etkisini yok saymak için !important gerekebilir veya style daha baskındır.
                });

                // Şık düzeni 'grid' veya 'flex-wrap' olanlar için gap row-gap ile çalışır
                // 'space-y' olanlar için (varsayılan) üstteki margin loop'u çalışır.
            }

            function soruBoslukDegistir(val) {
                // space-y-8 (2rem = 32px) varsayılan
                // Slider 20-200 arası. 
                // Space-y mantığı: Child elemanlara (ilk hariç) margin-top ekler.
                const container = document.getElementById('sorularContainer');
                if (!container) return;

                // space-y-8 class'ını kaldır ki bizim inline style'ımız (margin-top) çakışmasın veya üzerine yazsın.
                // Aslında inline style class'ı ezer, yani kaldırmaya gerek yok ama temizlik için:
                container.classList.remove('space-y-8');

                const sorular = container.children;
                for (let i = 1; i < sorular.length; i++) {
                    sorular[i].style.marginTop = val + 'px';
                }
            }

            function sayfaSinirlariniGoster(btn) {
                const sinavKagidi = document.getElementById('sinavKagidi');
                let kilavuzKatmani = document.getElementById('kilavuz-katmani');

                if (!kilavuzKatmani) {
                    // Katmanı oluştur
                    kilavuzKatmani = document.createElement('div');
                    kilavuzKatmani.id = 'kilavuz-katmani';
                    kilavuzKatmani.className = 'absolute top-0 left-0 w-full no-print pointer-events-none z-0';
                    kilavuzKatmani.style.height = '100%';

                    // A4 yüksekliği: 297mm
                    // Her sayfa sınırında kırmızı çizgi göster
                    kilavuzKatmani.style.background = `repeating-linear-gradient(
                to bottom,
                transparent,
                transparent calc(297mm - 1px),
                rgba(255, 0, 0, 0.4) calc(297mm - 1px),
                rgba(255, 0, 0, 0.4) 297mm
            )`;

                    // Soru kağıdına göre konumlandır
                    if (getComputedStyle(sinavKagidi).position === 'static') {
                        sinavKagidi.style.position = 'relative';
                    }
                    sinavKagidi.appendChild(kilavuzKatmani);

                    // Buton stilini güncelle (AKTİF - YEŞİL)
                    btn.classList.remove('bg-white', 'border-slate-200', 'text-slate-600');
                    btn.classList.add('bg-emerald-50', 'border-emerald-200', 'text-emerald-700', 'font-bold');
                    btn.querySelector('span').innerText = 'Sınırları Gizle';

                    // İkonu güncelle (isteğe bağlı, yeşil yapalabiliriz)
                    const icon = btn.querySelector('i');
                    if (icon) icon.style.color = '#047857'; // emerald-700

                } else {
                    // Katmanı kaldır
                    kilavuzKatmani.remove();

                    // Buton stilini güncelle (PASİF - BEYAZ)
                    btn.classList.remove('bg-emerald-50', 'border-emerald-200', 'text-emerald-700', 'font-bold');
                    btn.classList.add('bg-white', 'border-slate-200', 'text-slate-600');
                    btn.querySelector('span').innerText = 'Sınırları Göster';

                    const icon = btn.querySelector('i');
                    if (icon) icon.style.color = ''; // reset
                }
            }

            // Sayfa yüklendiğinde sınırları otomatik göster
            document.addEventListener('DOMContentLoaded', () => {
                const btn = document.getElementById('sinirBtn');
                if (btn) {
                    sayfaSinirlariniGoster(btn);
                }
            });

            // İkonları yükle
            setTimeout(() => lucide.createIcons(), 100);

            // AYAR KAYDETME VE CANLI ÖNİZLEME
            let ayarGuncelleTimeout;

            function ayarKaydet(key, value) {
                clearTimeout(ayarGuncelleTimeout);
                ayarGuncelleTimeout = setTimeout(async () => {
                    try {
                        const payload = {};
                        payload[key] = parseInt(value);

                        await fetch('/api/sinav-ayar-guncelle/{{ sinav.id }}', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        console.log('Ayar kaydedildi:', key, value);
                    } catch (err) {
                        console.error('Ayar kaydedilemedi:', err);
                    }
                }, 500);
            }

            function puanKutusuDegistir(val) {
                document.getElementById('puanKutusuLabel').textContent = '%' + val;

                // Ekran (Box)
                const scoreBoxes = document.querySelectorAll('.flex-shrink-0.ml-2.pt-1.no-print');
                scoreBoxes.forEach(box => {
                    box.style.transform = `scale(${val / 100})`;
                });

                // Baskı (Text)
                const printScores = document.querySelectorAll('.hidden.print\\:block.text-right.mt-2.font-bold');
                printScores.forEach(el => {
                    el.style.fontSize = (val / 100) + 'em';
                });

                ayarKaydet('puan_kutusu_boyutu', val);
            }

            function sikBosluguDegistir(val) {
                document.getElementById('sikBosluguLabel').textContent = val + 'px';

                const containers = document.querySelectorAll('.siklar-container');
                containers.forEach(el => {
                    el.style.marginTop = val + 'px';
                });

                ayarKaydet('sik_boslugu', val);
            }

            function siklarArasiDegistir(val) {
                document.getElementById('siklarArasiLabel').textContent = val + 'px';

                const containers = document.querySelectorAll('.siklar-container');
                containers.forEach(el => {
                    el.style.rowGap = val + 'px';
                });

                ayarKaydet('siklar_arasi_bosluk', val);
            }

            function baslikBoyutuDegistir(val) {
                document.getElementById('baslikBoyutuLabel').textContent = '%' + val;

                document.querySelectorAll('.baslik-metin').forEach(el => {
                    const base = parseFloat(el.getAttribute('data-base-size'));
                    if (base) {
                        el.style.fontSize = (base * val / 100) + 'px';
                    }
                });

                ayarKaydet('baslik_katsayisi', val);
            }

            function siklarYatayDegistir(val) {
                document.getElementById('siklarYatayLabel').textContent = val + 'px';

                const containers = document.querySelectorAll('.siklar-container');
                containers.forEach(el => {
                    el.style.columnGap = val + 'px';
                });

                ayarKaydet('siklar_yatay_bosluk', val);
            }
            function ustBoslukDegistir(val) {
                document.getElementById('ustBoslukLabel').textContent = val + 'px';
                document.getElementById('sinavKagidi').style.paddingTop = val + 'px';
                ayarKaydet('ust_bosluk', val);
            }

            function imzaAltBoslukDegistir(val) {
                document.getElementById('imzaAltBoslukLabel').textContent = val + 'px';
                const imzaAlani = document.getElementById('anaImzaAlani');
                if (imzaAlani) {
                    imzaAlani.style.marginBottom = val + 'px';
                }
                ayarKaydet('imza_alt_bosluk', val);
            }

            let odakliSoruId = null;

            function soruOdakla(el) {
                // Önceki odağı temizle
                document.querySelectorAll('.sayfa-odakli').forEach(item => item.classList.remove('sayfa-odakli'));

                // Yeni odak ekle
                el.classList.add('sayfa-odakli');
                odakliSoruId = el.getAttribute('data-soru-id');

                // Kontrol panelini güncelle
                const panel = document.getElementById('odakli-padding-kontrol');
                const baslik = document.getElementById('padding-kontrol-baslik');
                const slider = document.getElementById('sayfa2UstBoslukSlider');
                const currentMargin = parseInt(window.getComputedStyle(el).marginTop);

                panel.classList.add('border-indigo-400', 'bg-indigo-50/30');
                baslik.innerText = `Soru ${el.querySelector('.sira-no')?.innerText || ''} Üst Boşluğu`;
                slider.value = currentMargin;
                document.getElementById('sayfa2UstBoslukLabel').innerText = currentMargin + 'px';

                toastGoster('Sayfa/Soru ayarları aktif', 'info');
            }

            function odakliPaddingGuncelle(val) {
                document.getElementById('sayfa2UstBoslukLabel').textContent = val + 'px';

                if (odakliSoruId) {
                    // Sadece seçili soruya uygula
                    const el = document.querySelector(`.soru-blok[data-soru-id="${odakliSoruId}"]`);
                    if (el) {
                        el.style.marginTop = val + 'px';
                        // Backend'e kaydet (Debounced olmalıydı ama doğrudan atalım şimdilik)
                        fetch(`/sinav-soru-bosluk-guncelle/{{ sinav.id }}/${odakliSoruId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ust_bosluk: parseInt(val) })
                        });
                    }
                } else {
                    // Global sayfa2üstbosluk olarak çalış (Geleneksel davranış)
                    const sayfaBaslari = document.querySelectorAll('.sayfa-basi');
                    sayfaBaslari.forEach(el => {
                        el.style.marginTop = val + 'px';
                    });
                    ayarKaydet('sayfa2_ust_bosluk', val);
                }
            }

            // Sayfanın boş bir yerine tıklanınca odağı sıfırla
            document.getElementById('sinavKagidi').addEventListener('click', (e) => {
                if (e.target.id === 'sinavKagidi' || e.target.classList.contains('a4-sayfa')) {
                    document.querySelectorAll('.sayfa-odakli').forEach(item => item.classList.remove('sayfa-odakli'));
                    odakliSoruId = null;

                    const panel = document.getElementById('odakli-padding-kontrol');
                    const baslik = document.getElementById('padding-kontrol-baslik');
                    panel.classList.remove('border-indigo-400', 'bg-indigo-50/30');
                    baslik.innerText = "Genel Sayfa Üst Boşluğu";
                }
            });

            function sayfa2UstBoslukDegistir(val) {
                // Bu artık odakliPaddingGuncelle tarafından karşılanıyor
                odakliPaddingGuncelle(val);
            }

            // SAYFA BÖLME MODU 
            let sayfaBolmeModu = false;

            function toggleSayfaBolmeModu() {
                sayfaBolmeModu = !sayfaBolmeModu;
                const btn = document.getElementById('sayfaBolmeBtn');

                if (sayfaBolmeModu) {
                    document.body.classList.add('sayfa-bolme-modunda');
                    btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                    btn.classList.remove('bg-white', 'text-slate-600');
                    toastGoster('Sayfa Bölme Modu Aktif. Bölmek istediğiniz sorunun üzerine tıklayın.', 'info');
                } else {
                    document.body.classList.remove('sayfa-bolme-modunda');
                    btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                    btn.classList.add('bg-white', 'text-slate-600');
                    toastGoster('Sayfa Bölme Modu Kapatıldı.', 'info');
                }
            }

            // Soru bloklarına tıklama olayını ekle
            document.addEventListener('click', (e) => {
                if (!sayfaBolmeModu) return;

                const soruBlok = e.target.closest('.soru-blok');
                if (soruBlok) {
                    e.preventDefault();
                    e.stopPropagation();

                    soruBlok.classList.toggle('sayfa-basi');
                    const silBtn = soruBlok.querySelector('.sayfa-sil-onay-btn');

                    if (soruBlok.classList.contains('sayfa-basi')) {
                        if (silBtn) silBtn.classList.remove('hidden');
                        toastGoster('Yeni sayfa başlatıldı.', 'success');
                    } else {
                        if (silBtn) silBtn.classList.add('hidden');
                        toastGoster('Sayfa bölümü kaldırıldı.', 'info');
                    }

                    // Refresh boundaries if open
                    const sinirBtn = document.getElementById('sinirBtn');
                    if (sinirBtn && document.getElementById('kilavuz-katmani')) {
                        sayfaSinirlariniGoster(sinirBtn);
                        sayfaSinirlariniGoster(sinirBtn);
                    }

                    setTimeout(() => lucide.createIcons(), 50);
                }
            }, true); // Use capture to intercept before other events

            function sayfaSil(btn) {
                const soruBlok = btn.closest('.soru-blok');
                soruBlok.classList.remove('sayfa-basi');
                btn.classList.add('hidden');

                // Kılavuz katmanını güncelle
                const sinirBtn = document.getElementById('sinirBtn');
                if (sinirBtn && document.getElementById('kilavuz-katmani')) {
                    sayfaSinirlariniGoster(sinirBtn);
                    sayfaSinirlariniGoster(sinirBtn);
                }

                toastGoster('Sayfa bölümü kaldırıldı', 'success');
            }

            function sayfaSonuToggle(btn) {
                const soruBlok = btn.closest('.soru-blok');
                soruBlok.classList.toggle('sayfa-basi');
                const silBtn = soruBlok.querySelector('.sayfa-sil-onay-btn');

                if (soruBlok.classList.contains('sayfa-basi')) {
                    if (silBtn) silBtn.classList.remove('hidden');
                    toastGoster('Soru yeni sayfadan başlayacak', 'info');
                } else {
                    if (silBtn) silBtn.classList.add('hidden');
                }

                // Kılavuz katmanını güncelle
                const sinirBtn = document.getElementById('sinirBtn');
                if (sinirBtn && document.getElementById('kilavuz-katmani')) {
                    // Kapat-aç yaparak refresh et
                    sayfaSinirlariniGoster(sinirBtn);
                    sayfaSinirlariniGoster(sinirBtn);
                }

                setTimeout(() => lucide.createIcons(), 50);
            }

            function sayfaSil(btn) {
                const soruBlok = btn.closest('.soru-blok');
                soruBlok.classList.remove('sayfa-basi');
                btn.classList.add('hidden');

                // Kılavuz katmanını güncelle
                const sinirBtn = document.getElementById('sinirBtn');
                if (sinirBtn && document.getElementById('kilavuz-katmani')) {
                    sayfaSinirlariniGoster(sinirBtn);
                    sayfaSinirlariniGoster(sinirBtn);
                }

                toastGoster('Sayfa bölümü kaldırıldı', 'success');
            }

            // Mouse ile Boşluk Ayarı (Dragging)
            let currentDraggingHandle = null;
            let startY = 0;
            let startMarginTop = 0;

            function startSpacerDrag(e, handle) {
                e.preventDefault();
                currentDraggingHandle = handle;
                startY = e.clientY;
                const soruBlok = handle.closest('.soru-blok');
                startMarginTop = parseInt(window.getComputedStyle(soruBlok).marginTop);

                handle.classList.add('dragging');
                document.addEventListener('mousemove', onSpacerDrag);
                document.addEventListener('mouseup', stopSpacerDrag);

                // Seçimi engelle
                document.body.style.userSelect = 'none';
            }

            function onSpacerDrag(e) {
                if (!currentDraggingHandle) return;
                const deltaY = e.clientY - startY;
                const soruBlok = currentDraggingHandle.closest('.soru-blok');
                let newMarginTop = Math.max(0, startMarginTop + deltaY);
                soruBlok.style.marginTop = newMarginTop + 'px';
            }

            function stopSpacerDrag() {
                if (currentDraggingHandle) {
                    const soruBlok = currentDraggingHandle.closest('.soru-blok');
                    const soruId = soruBlok.getAttribute('data-soru-id');
                    const newMargin = parseInt(soruBlok.style.marginTop);

                    // Backend'e kaydet
                    fetch(`/sinav-soru-bosluk-guncelle/{{ sinav.id }}/${soruId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ust_bosluk: newMargin })
                    });

                    currentDraggingHandle.classList.remove('dragging');
                }
                currentDraggingHandle = null;
                document.removeEventListener('mousemove', onSpacerDrag);
                document.removeEventListener('mouseup', stopSpacerDrag);
                document.body.style.userSelect = 'auto';
            }

            // Sayfa açıldığında SortableJS'i ana kağıt için de aktif et
            document.addEventListener('DOMContentLoaded', () => {
                const el = document.getElementById('sorularContainer');
                if (el) {
                    Sortable.create(el, {
                        animation: 150,
                        handle: '.drag-handle',
                        filter: '.no-drag', // no-drag sınıfı olan elemanlarda sürüklemeyi kapat
                        preventOnFilter: false, // Filtreye takılan elemanlarda tıklamaya izin ver
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        onEnd: function () {
                            const siralamas = [];
                            document.querySelectorAll('#sorularContainer > .soru-blok').forEach((el, index) => {
                                siralamas.push({
                                    soru_id: el.getAttribute('data-soru-id'),
                                    sira: index + 1
                                });
                            });

                            // Yeni sıralamayı kaydet
                            fetch(`/sinav-soru-sirala/{{ sinav.id }}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ siralamas: siralamas })
                            }).then(res => res.json()).then(data => {
                                if (data.basarili) {
                                    // Sayfayı yenileyerek numaraları ve page-breakleri düzeltebiliriz 
                                    // ya da JS ile numaraları güncelleyebiliriz (şimdilik yenileyelim)
                                    location.reload();
                                }
                            });
                        }
                    });
                }
            });
        </script>

        <!-- Soru Sıralama Modalı -->
        <div id="siralaModal"
            class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden animate-fade-in">
                <div class="gradient-primary p-6 text-white flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i data-lucide="list-ordered" class="w-6 h-6"></i>
                        <div>
                            <h3 class="text-xl font-bold">Soru Sıralamasını Düzenle</h3>
                            <p class="text-xs opacity-80 mt-1">Sürükleyerek soruların yerini değiştirebilirsiniz</p>
                        </div>
                    </div>
                    <button onclick="soruSiralamayiKapat()" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="p-6 max-h-[60vh] overflow-y-auto" id="siralanabilirListe">
                    {% for sinav_sorusu in sinav.sorular %}
                    <div class="flex items-center gap-4 p-4 mb-3 bg-slate-50 border border-slate-200 rounded-xl cursor-move hover:bg-white hover:border-indigo-300 hover:shadow-md transition-all group"
                        data-soru-id="{{ sinav_sorusu.soru.id }}">
                        <div class="flex-shrink-0 flex flex-col items-center gap-1">
                            <i data-lucide="grip-vertical"
                                class="w-5 h-5 text-slate-300 group-hover:text-indigo-400"></i>
                            <span class="text-xs font-bold text-slate-400 group-hover:text-indigo-600 sira-no">{{
                                loop.index }}</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-700 line-clamp-2">{{ sinav_sorusu.soru.soru_metni
                                }}</p>
                            <div
                                class="flex items-center gap-3 mt-1 text-[10px] text-slate-500 uppercase tracking-wider">
                                <span>{{ sinav_sorusu.soru.konu or 'Konusuz' }}</span>
                                <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                                <span>{{ sinav_sorusu.soru.puan }} Puan</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="p-6 bg-slate-50 border-t border-slate-200 flex items-center justify-end gap-3">
                    <button onclick="soruSiralamayiKapat()"
                        class="px-5 py-2.5 text-sm font-semibold text-slate-600 hover:text-slate-800 transition-colors">
                        İptal
                    </button>
                    <button onclick="siralamayiKaydet()"
                        class="px-6 py-2.5 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-600/20 hover:bg-indigo-700 transition-all flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Sıralamayı Kaydet
                    </button>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
        {% endblock %}
        ```